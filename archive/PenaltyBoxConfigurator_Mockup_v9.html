
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Penalty Box Configurator – Interactive Mockup (v9)</title>
<style>
  :root { --bg:#0f1115; --panel:#171a21; --panel-2:#1f2430; --text:#e6e9ef; --muted:#a5adcb; --accent:#7aa2f7; --ok:#73daca; --warn:#e0af68; --err:#f7768e; --badge:#2b3245; --btn:#2d3344; --btn-h:#3b435a; --link:#86aaec; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid #222635;background:#11141a;position:sticky;top:0;z-index:3}
  header h1{font-size:18px;margin:0;font-weight:600;letter-spacing:.3px}
  .toolbar{display:flex;gap:8px;margin-left:auto}
  button,.btn{background:var(--btn);color:var(--text);border:1px solid #2b3040;border-radius:6px;padding:8px 10px;cursor:pointer;font-size:13px}
  button:hover,.btn:hover{background:var(--btn-h)}
  .btn-primary{background:#26406b;border-color:#2f4d81}
  .btn-primary:hover{background:#315587}
  .btn-danger{background:#5a2330;border-color:#6b2a39}
  .btn-danger:hover{background:#6b2a39}
  .layout{display:grid;grid-template-columns:280px 1fr 360px;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid #22283a;border-radius:10px;padding:12px}
  .panel h2{font-size:14px;margin:0 0 8px 0;font-weight:600;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:6px;max-height:calc(100vh - 170px);overflow:auto;padding-right:4px}
  .list-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:var(--panel-2);border:1px solid #2b3245;cursor:pointer}
  .list-item:hover{border-color:#3a445f}
  .list-item.active{outline:2px solid var(--accent)}
  .badge{padding:2px 6px;border-radius:999px;font-size:11px;background:var(--badge);color:var(--muted)}
  .badge.ok{background:#13342f;color:var(--ok)}
  .badge.warn{background:#3c3017;color:var(--warn)}
  .badge.err{background:#3b1b23;color:var(--err)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;color:var(--muted)}
  select,input[type="text"],input[type="number"],textarea{background:#0f1320;color:var(--text);border:1px solid #2b3245;border-radius:6px;padding:8px;font-size:13px}
  input[type="checkbox"]{transform:translateY(1px)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .section{border-top:1px dashed #2b3245;margin-top:10px;padding-top:10px}
  .muted{color:var(--muted);font-size:12px}
  .pill{padding:6px 8px;background:#0f1320;border:1px solid #2b3245;border-radius:6px;font-size:12px}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:6px;align-items:center}
  .status-item{background:var(--panel-2);border:1px solid #2b3245;border-radius:8px;padding:8px;margin-bottom:8px}
  .status-item .title{font-weight:600;font-size:13px}
  .footer{text-align:center;color:var(--muted);font-size:12px;padding:12px}
  .search{width:100%}
  .toolbar-inline{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .stack{display:flex;flex-direction:column;gap:8px}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{border-bottom:1px solid #2b3245;padding:6px 8px;text-align:left;vertical-align:top}
  .table th{color:var(--muted);font-weight:600}
  .link{color:var(--link);cursor:pointer;text-decoration:underline}
  dialog{border:1px solid #2b3245;background:var(--panel);color:var(--text);border-radius:10px;padding:0;width:1000px;max-width:96vw}
  dialog header{padding:12px 14px;border-bottom:1px solid #2b3245;background:var(--panel-2)}
  dialog .content{padding:12px}
  dialog .actions{padding:12px;border-top:1px solid #2b3245;display:flex;gap:8px;justify-content:flex-end}
  .small{font-size:12px}
  .code{background:#0b0f1a;border:1px solid #20283e;padding:8px;border-radius:8px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#cbd5f7}
  .listbox{height:240px;width:100%;background:#0f1320;border:1px solid #2b3245;border-radius:6px;padding:6px;overflow:auto}
  .listbox .itm{padding:4px 6px;border-bottom:1px dashed #232a3d;cursor:pointer;display:flex;justify-content:space-between;gap:6px}
  .listbox .itm:hover{background:#151a2a}
  .pill-tag{display:inline-block;padding:2px 6px;margin:2px;border-radius:999px;background:#0f1320;border:1px solid #2b3245;font-size:12px}
  .dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
  .src{font-size:11px;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <h1>Penalty Box Configurator – Mockup <span class="muted">v9</span></h1>
    <span class="badge" id="licenseBadge">License: <strong>Missing</strong></span>
    <label class="row" style="margin-left:8px"><input type="checkbox" id="licenseToggle"/> <span class="muted">Simulate License</span></label>
    <span class="badge" id="mvBadge"><span class="dot" id="mvDot"></span><strong>MapView:</strong> <span id="mvText">Stopped</span></span>
    <label class="row small" style="margin-left:4px">State
      <select id="mvSelect">
        <option>Running</option>
        <option>Starting</option>
        <option selected>Stopped</option>
        <option>Error</option>
      </select>
    </label>
    <div class="toolbar">
      <button id="btnCreate">Create</button>
      <button id="btnDuplicate">Duplicate</button>
      <button id="btnUndo">Undo</button>
      <button id="btnIO">Import/Export</button>
      <button id="btnTemplates">Templates</button>
      <button id="btnGenerate" class="btn-primary">Generate</button>
      <button id="btnLoadSample">Load Sample</button>
    </div>
  </header>

  <div class="layout">
    <div class="panel">
      <div class="toolbar-inline">
        <h2>Favourites</h2>
        <input class="search" id="searchGroups" placeholder="Search favourites..." />
      </div>
      <div class="list" id="groupList"></div>
    </div>

    <div class="panel" id="editorPanel">
      <h2>Group Editor</h2>
      <div class="stack" id="editorEmpty">
        <div class="muted">Select a favourite (alarm group) to edit, or click <strong>Create</strong>.</div>
      </div>
      <div class="stack" id="editor" style="display:none;">
        <div class="grid-3">
          <div class="stack">
            <label>Group Name</label>
            <input id="groupName" type="text" />
          </div>
          <div class="stack">
            <label>MbyE Identifier</label>
            <div class="pill" id="groupIdentifier">EM::</div>
          </div>
          <div class="stack">
            <label>Settings Mode</label>
            <div class="row small">
              <label><input type="radio" name="settingsMode" id="modeGlobal" value="global"> Global Settings</label>
              <label><input type="radio" name="settingsMode" id="modeLocal" value="local"> Local Settings</label>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="row" style="justify-content: space-between;">
            <h3 style="margin:0;font-size:13px;color:var(--muted)">Sub-groups</h3>
            <button id="btnAddSubGroup">Add Sub-group</button>
          </div>
          <table class="table" id="subGroupTable">
            <thead>
              <tr><th>Name</th><th>Alarm Path</th><th>Template</th><th>Devices</th><th>Children</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="section grid-3">
          <div class="stack">
            <label>In Error State</label>
            <select id="inErrorState">
              <option value="50">Minor / WARN (50)</option>
              <option value="75">Major (75)</option>
              <option value="100">Critical / FAIL (100)</option>
            </select>
          </div>
          <div class="stack">
            <label>Error Positions (top-N)</label>
            <input id="errorPositions" type="number" min="1" max="50" value="2" />
          </div>
          <div class="stack">
            <label>Sorting</label>
            <div class="row">
              <select id="primarySort"><option>Priority</option><option>State</option><option>Date (Newest First)</option><option>Address</option></select>
              <select id="secondarySort"><option>State</option><option>Priority</option><option>Date (Newest First)</option><option>Address</option></select>
              <select id="tertiarySort"><option>Date (Newest First)</option><option>Priority</option><option>State</option><option>Address</option></select>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="grid-2">
            <div class="stack">
              <label>Local Settings (overrides Global when selected)</label>
              <div class="kv">
                <div>Layout Orientation</div>
                <select id="lvOrientation"><option>Vertical</option><option>Horizontal</option></select>
                <div>Cell Spacing</div>
                <input id="lvCellSpacing" type="number" min="0" max="64" value="8" />
                <div>Enable Latching</div>
                <input id="lvLatching" type="checkbox" checked />
                <div>Item Size</div>
                <input id="lvItemSize" type="number" value="320"/>
                <div>Show Address</div>
                <div class="row"><input id="lvShowAddr" type="checkbox" checked/><label for="lvShowAddr">Show Address</label></div>
                <div>Show Priority</div>
                <div class="row"><input id="lvShowPrio" type="checkbox" checked/><label for="lvShowPrio">Show Priority</label></div>
                <div>Show Timestamp</div>
                <div class="row"><input id="lvShowTs" type="checkbox" checked/><label for="lvShowTs">Show Timestamp</label></div>
              </div>
            </div>
            <div class="stack">
              <label>Identifier & Preview</label>
              <div class="code" id="previewCode">// Behaviour preview will appear here</div>
            </div>
          </div>
        </div>

        <div class="section">
          <button class="btn-primary" id="btnSaveGroup">Save Group</button>
          <button class="btn-danger" id="btnDeleteGroup">Delete Group</button>
        </div>
      </div>
    </div>

    <div class="panel right-form">
      <h2>Global Settings</h2>
      <div class="kv">
        <div>Layout Orientation</div>
        <select id="g_pvOrientation"><option>Vertical</option><option>Horizontal</option></select>
        <div>Cell Spacing</div>
        <input id="g_pvCellSpacing" type="number" min="0" max="64" value="8" />
        <div>Enable Latching</div>
        <input id="g_pvLatching" type="checkbox" checked />
        <div>Item Size</div>
        <input id="g_pvItemSize" type="number" value="320"/>
        <div>Show Address</div>
        <input id="g_pvShowAddr" type="checkbox" checked />
        <div>Show Priority</div>
        <input id="g_pvShowPrio" type="checkbox" checked />
        <div>Show Timestamp</div>
        <input id="g_pvShowTs" type="checkbox" checked />
        <div>Master Penalty Box Slots</div>
        <input id="g_masterSlots" type="number" min="1" max="100" value="10" />
      </div>
      <div class="section">
        <button id="btnApplyPV" class="btn-primary">Apply to Project</button>
        <button id="btnResetPV">Reset to Defaults</button>
        <div class="muted small">Applies globals and (in real app) **generates** screens + <code>Penalty_Box.globalx</code> & **writes templates** into the Project.</div>
      </div>
      <div class="section">
        <h2>Validation & Status</h2>
        <div class="status-item"><div class="title">Project Validation</div><div class="muted small" id="statusProject">No favourites yet.</div></div>
        <div class="status-item"><div class="title">Selected Group</div><div class="muted small" id="statusGroup">None selected.</div></div>
      </div>
    </div>
  </div>

  <div class="footer">Interactive mockup – non-persistent. Use <strong>Load Sample</strong> or <strong>Import/Export</strong> to populate data.</div>

  <!-- IO Dialog (Import/Export) with file inputs -->
  <dialog id="dlgIO">
    <header><strong>Import / Export</strong></header>
    <div class="content grid-2">
      <div class="stack">
        <label class="small">Import configuration <code>.json</code></label>
        <input id="ioConfigFile" type="file" accept="application/json,.json" />
        <div class="row"><button id="ioImportConfig" class="btn-primary">Import Config</button></div>
        <div class="muted small">Replaces favourites, templates and project settings from JSON.</div>
        <div class="section"></div>
        <label class="small">Import templates <code>.tmpl</code> (one or more)</label>
        <input id="ioTemplateFiles" type="file" accept=".tmpl,text/plain" multiple />
        <div class="row"><button id="ioImportTemplates" class="btn-primary">Import Templates</button></div>
        <div class="muted small">Each <code>.tmpl</code> file name becomes the template name; file lines become headers.</div>
      </div>
      <div class="stack">
        <label class="small">Export current configuration</label>
        <div class="code small">Exports: projectVars, master, templates, groups (with nested sub-groups & devices)</div>
        <div class="row"><button id="ioExportRun" class="btn-primary">Download Export (.json)</button></div>
      </div>
    </div>
    <div class="actions"><button id="ioClose">Close</button></div>
  </dialog>

  <!-- Pick Template Dialog -->
  <dialog id="dlgPickTemplate">
    <header><strong>Pick Template</strong></header>
    <div class="content stack">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <input id="tplPickSearch" class="search" placeholder="Search templates..."/>
        <div class="row small">
          <label><input type="checkbox" id="tplIncludeProject"/> Include Project (MapView)</label>
          <button id="tplRefreshProject">Refresh Project</button>
        </div>
      </div>
      <div class="listbox" id="tplPickList"></div>
      <div class="muted small" id="tplPickHint">Double‑click a row, or select and press Choose.</div>
    </div>
    <div class="actions">
      <button id="tplPickCancel">Cancel</button>
      <button id="tplPickChoose" class="btn-primary">Choose</button>
    </div>
  </dialog>

  <!-- Create/Duplicate/Generate/Sub-group/Templates/Template Editor (same as v8) -->
  <dialog id="dlgCreate">
    <header><strong>Create Favourite (Alarm Group)</strong></header>
    <div class="content stack">
      <div class="stack"><label>Name</label><input id="newGroupName" type="text" placeholder="e.g., Channel 4"/></div>
      <div class="muted small">An Exception Monitor will be created with identifier <code>EM::{GroupName}</code>.</div>
    </div>
    <div class="actions"><button id="createCancel">Cancel</button><button id="createOk" class="btn-primary">Create</button></div>
  </dialog>

  <dialog id="dlgDuplicate">
    <header><strong>Duplicate Favourite(s)</strong></header>
    <div class="content stack">
      <div class="grid-3">
        <div class="stack"><label>Base Name</label><input id="dupBaseName" type="text" placeholder="Channel %d"/></div>
        <div class="stack"><label>Count (1-999)</label><input id="dupCount" type="number" min="1" max="999" value="3"/></div>
        <div class="stack"><label>Structure Only</label><input id="dupStructureOnly" type="checkbox"/></div>
      </div>
      <div class="muted small">Use %d for decimal index or %x for hex. Undo available.</div>
    </div>
    <div class="actions"><button id="dupCancel">Cancel</button><button id="dupOk" class="btn-primary">Duplicate</button></div>
  </dialog>

  <dialog id="dlgGenerate">
    <header><strong>Generate Behaviours & Screens</strong></header>
    <div class="content stack">
      <div class="muted small">This will create Exception Monitor behaviours in <code>Penalty_Box.globalx</code> and MapView/AMPP screens per favourite + master (mocked).</div>
      <ul class="small">
        <li>Validate unique identifiers</li>
        <li>Apply templates to sub-groups</li>
        <li>Set In-Error threshold and top-N positions</li>
        <li>Bind widget properties to PB.EM.* variables</li>
      </ul>
    </div>
    <div class="actions"><button id="genCancel">Cancel</button><button id="genOk" class="btn-primary">Run</button></div>
  </dialog>

  <dialog id="dlgSubGroup">
    <header><strong>Edit Sub-group</strong></header>
    <div class="content stack">
      <div class="grid-2">
        <div class="stack"><label>Name</label><input id="sgName" type="text"/></div>
        <div class="stack"><label>Alarm Path (auto)</label><input id="sgFav" type="text" readonly/></div>
      </div>
      <div class="grid-2">
        <div class="stack"><label>Template</label>
          <div class="row">
            <input id="sgTemplate" type="text" placeholder="Dave.tmpl"/>
            <button id="sgPickTemplate">Pick…</button>
            <button id="sgViewTemplate">View</button>
          </div>
        </div>
        <div class="stack"><label>Add Address</label>
          <div class="row"><input id="sgDevAddr" type="text" placeholder="F110:01:01 or Favourites/Servers/MapView Service"/>
          <button id="sgPickAddr">Pick…</button><button id="sgAddDev">Add</button></div>
          <div class="muted small">Picker would query a Monitoring Service (not implemented in this mockup).</div>
        </div>
      </div>
      <table class="table" id="sgDevTable"><thead><tr><th>Address</th><th></th></tr></thead><tbody></tbody></table>
      <div class="section">
        <div class="row" style="justify-content: space-between;align-items:center;">
          <h3 style="margin:0;font-size:13px;color:var(--muted)">Child Sub-groups</h3>
          <button id="sgAddChild">Add Child Sub-group</button>
        </div>
        <div id="sgChildren"></div>
      </div>
    </div>
    <div class="actions"><button id="sgCancel">Cancel</button><button id="sgOk" class="btn-primary">Save</button></div>
  </dialog>

  <dialog id="dlgTemplates">
    <header><strong>Templates</strong></header>
    <div class="content stack">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <div class="row">
          <button id="tplCreate">Create Template</button>
          <button id="tplEdit">Edit Template</button>
          <button id="tplDelete" class="btn-danger">Delete</button>
        </div>
        <div class="row">
          <input id="tplFiles" type="file" accept=".tmpl,text/plain" multiple />
          <button id="tplImportFiles">Import .tmpl</button>
          <button id="tplExport">Export</button>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label class="small">Templates</label>
          <div class="listbox" id="tplList"></div>
        </div>
        <div>
          <label class="small">Quick View</label>
          <div class="code" id="tplQuickView">Select a template to view its headers.</div>
        </div>
      </div>
    </div>
    <div class="actions"><button id="tplClose">Close</button></div>
  </dialog>

  <dialog id="dlgTplEditor">
    <header><strong id="tplEdTitle">Create Template</strong></header>
    <div class="content stack">
      <div class="grid-2">
        <div class="stack"><label>Template Name</label><input id="tplName" type="text" placeholder="e.g., services.tmpl"/></div>
        <div class="stack"><label>Mode</label>
          <div class="row small">
            <label><input type="radio" name="tplMode" id="tplModePerUnit" value="perUnit" checked> Headers per Unit</label>
            <label><input type="radio" name="tplMode" id="tplModeAll" value="all"> All Headers</label>
          </div>
        </div>
      </div>
      <div id="tplPerUnitArea" class="section">
        <div class="stack">
          <label class="small">Units (addresses) in context</label>
          <div class="row">
            <input id="tplUnitAddr" type="text" placeholder="F110:01:01"/>
            <button id="tplAddUnit">Add Unit</button>
            <button id="tplUseGroupUnits">Use current group's devices</button>
            <button id="tplClearUnits">Clear</button>
          </div>
          <div id="tplUnits" class="row"></div>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label class="small">Available Headers</label>
          <div class="listbox" id="tplAvail"></div>
        </div>
        <div>
          <label class="small">Template Headers</label>
          <div class="listbox" id="tplSelected"></div>
        </div>
      </div>
      <div class="row" style="justify-content:center;">
        <button id="tplAddHdr">Add →</button>
        <button id="tplRemoveHdr">← Remove</button>
      </div>
    </div>
    <div class="actions"><button id="tplEdCancel">Cancel</button><button id="tplEdSave" class="btn-primary">Save</button></div>
  </dialog>

<script>
  // --- App state ---
  const state = {
    licensed:false,
    mapView:'Stopped',
    groups:[],
    lastAction:null,
    projectVars:{ orientation:'Vertical', cellSpacing:8, latching:true, itemSize:320, showAddr:true, showPrio:true, showTs:true },
    master:{ id:'EM::Penalty Box', inError:50, errorPositions:10, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'} },
    templates:[],            // tool-defined templates (editor/import)
    projectTemplates:[],     // fetched from MapView project (simulated)
    lastPushedTemplates:{}   // { name: signature }
  };

  const HEADER_CATALOG=['CPU','MEMORY','DISK','NETWORK','PTP_LOCK','STREAM_STATE','INPUT_LOCK','OUTPUT_LOCK','HEALTH','TEMPERATURE','FAN','POWER','SIGNAL_PRESENCE','LATENCY','PACKET_LOSS'];
  const $=sel=>document.querySelector(sel); const uid=()=>Math.random().toString(36).slice(2,9);
  function download(filename,text){ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click(); }
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
  function headersForUnit(addr){ const seed=(addr||'').split('').reduce((a,c)=>a+c.charCodeAt(0),0); return HEADER_CATALOG.filter((_,i)=>((i+seed)%3)===0); }
  const tplSig = t => JSON.stringify({mode:t.mode, headers:t.headers, units:t.units});

  // MapView status badge
  function updateMvBadge(){ const b=$('#mvBadge'),dot=$('#mvDot'),t=$('#mvText'); const s=state.mapView; t.textContent=s; b.classList.remove('ok','warn','err'); dot.style.background='#666'; if(s==='Running'){ b.classList.add('ok'); dot.style.background='var(--ok)'; } else if(s==='Starting'){ b.classList.add('warn'); dot.style.background='var(--warn)'; } else if(s==='Error'){ b.classList.add('err'); dot.style.background='var(--err)'; } }
  $('#mvSelect').addEventListener('change',e=>{ state.mapView=e.target.value; updateMvBadge(); });

  // Favourites list & editor
  function renderGroups(filter=''){ const list=$('#groupList'); list.innerHTML=''; const q=(filter||'').toLowerCase(); state.groups.filter(g=>!q||g.name.toLowerCase().includes(q)).forEach(g=>{ const div=document.createElement('div'); div.className='list-item'+(g===state.sel?' active':''); const badge=document.createElement('span'); const v=validateGroup(g); badge.className='badge '+(v.ok?'ok':'warn'); badge.textContent=v.ok?'Complete':'Incomplete'; const name=document.createElement('div'); name.textContent=g.name; name.style.flex='1'; div.appendChild(badge); div.appendChild(name); div.onclick=()=>{ state.sel=g; openEditor(g); renderGroups($('#searchGroups').value); }; list.appendChild(div); }); $('#statusProject').textContent = state.groups.length? `${state.groups.length} favourite(s). Master slots: ${state.master.errorPositions}` : 'No favourites yet.'; }

  function openEditor(g){ $('#editorEmpty').style.display='none'; $('#editor').style.display=''; $('#groupName').value=g.name; $('#groupIdentifier').textContent=`EM::${g.name}`; const useGlobal=(g.useGlobalSettings!==false); $('#modeGlobal').checked=useGlobal; $('#modeLocal').checked=!useGlobal; setLocalControlsEnabled(!useGlobal); $('#inErrorState').value=String(g.inError??50); $('#errorPositions').value=g.errorPositions??2; $('#primarySort').value=g.sorts?.p??'Priority'; $('#secondarySort').value=g.sorts?.s??'State'; $('#tertiarySort').value=g.sorts?.t??'Date (Newest First)'; const src=useGlobal? state.projectVars : (g.localSettings||state.projectVars); $('#lvOrientation').value=src.orientation; $('#lvCellSpacing').value=src.cellSpacing; $('#lvLatching').checked=src.latching; $('#lvItemSize').value=src.itemSize; $('#lvShowAddr').checked=src.showAddr; $('#lvShowPrio').checked=src.showPrio; $('#lvShowTs').checked=src.showTs; renderSubGroups(g); renderPreview(g); $('#statusGroup').textContent=validateGroup(g).msg; }
  function setLocalControlsEnabled(enabled){ ['lvOrientation','lvCellSpacing','lvLatching','lvItemSize','lvShowAddr','lvShowPrio','lvShowTs'].forEach(id=>{ const el=$('#'+id); if(el){ el.disabled=!enabled; el.closest('div').style.opacity=enabled?'1':'0.6'; }}); }
  function renderSubGroups(g){ const tbody=$('#subGroupTable tbody'); tbody.innerHTML=''; (g.subGroups||[]).forEach((sg,idx)=>{ const childCount=(sg.subGroups||[]).length; const fav=autoFavPath(g.name, sg.__path||[sg.name]).join('/'); const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(sg.name||'')}</td><td>${escapeHtml(fav)}</td><td>${escapeHtml(sg.template||'')}</td><td>${(sg.devices||[]).length}</td><td>${childCount}</td><td><span class='link' data-idx='${idx}'>Edit</span> · <span class='link' data-del='${idx}'>Delete</span></td>`; tbody.appendChild(tr); }); tbody.onclick=e=>{ if(e.target.matches('[data-idx]')) editSubGroup(parseInt(e.target.getAttribute('data-idx'))); if(e.target.matches('[data-del]')){ const i=parseInt(e.target.getAttribute('data-del')); state.sel.subGroups.splice(i,1); renderSubGroups(state.sel); renderPreview(state.sel); } }; }
  function renderPreview(g){ const lines=[]; lines.push(`Identifier: EM::${g.name}`); lines.push(`In Error State: ${g.inError}`); lines.push(`Error Positions (N): ${g.errorPositions}`); lines.push(`Sort: ${g.sorts.p} / ${g.sorts.s} / ${g.sorts.t}`); lines.push(`Settings: ${g.useGlobalSettings!==false ? 'Global' : 'Local'}`); let itemCount=0; (function count(sgs){ (sgs||[]).forEach(s=>{ itemCount+=(s.devices||[]).length; count(s.subGroups); }); })(g.subGroups); lines.push(`Resolved Items: ${itemCount}`); $('#previewCode').textContent=lines.join('\n'); }
  function validateGroup(g){ if(!g.name) return {ok:false,msg:'Name required'}; if(state.groups.filter(x=>x!==g && x.name===g.name).length) return {ok:false,msg:'Name must be unique'}; if((g.subGroups||[]).length===0) return {ok:false,msg:'Add at least one sub-group'}; let devices=0; (function count(sgs){(sgs||[]).forEach(s=>{devices+=(s.devices||[]).length; count(s.subGroups);});})(g.subGroups); if(devices===0) return {ok:false,msg:'Add addresses to at least one sub-group'}; return {ok:true,msg:'Complete'}; }
  function autoFavPath(groupName,pathParts){ return ['Favourites',groupName,...pathParts.filter(Boolean)]; }
  function dlg(sel,cmd){ const d=$(sel); if(cmd==='open') d.showModal(); else d.close(); }

  // Header events
  $('#licenseToggle').addEventListener('change',e=>{ state.licensed=e.target.checked; $('#licenseBadge').innerHTML= state.licensed? 'License: <strong style="color:var(--ok)">OK</strong>' : 'License: <strong>Missing</strong>'; document.body.style.filter= state.licensed ? 'none':'grayscale(0.2)'; });

  // Create/Duplicate/Undo
  $('#btnCreate').onclick=()=> dlg('#dlgCreate','open'); $('#createCancel').onclick=()=> dlg('#dlgCreate','close');
  $('#createOk').onclick=()=>{ const name=$('#newGroupName').value.trim(); if(!name) return alert('Enter a name'); if(state.groups.find(g=>g.name===name)) return alert('Name must be unique'); const g={ id:uid(), name, inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, subGroups:[], useGlobalSettings:true, localSettings:{orientation:'Vertical',cellSpacing:8,latching:true,itemSize:320,showAddr:true,showPrio:true,showTs:true} }; state.groups.push(g); state.lastAction={type:'create',id:g.id}; renderGroups(); dlg('#dlgCreate','close'); state.sel=g; openEditor(g); };
  $('#btnDuplicate').onclick=()=>{ if(!state.sel) return alert('Select a favourite first'); $('#dupBaseName').value=state.sel.name+' %d'; dlg('#dlgDuplicate','open'); };
  $('#dupCancel').onclick=()=> dlg('#dlgDuplicate','close');
  $('#dupOk').onclick=()=>{ const base=$('#dupBaseName').value.trim(); const count=Math.max(1,Math.min(999, parseInt($('#dupCount').value||'1'))); const structureOnly=$('#dupStructureOnly').checked; if(!/%[dx]/.test(base)) return alert('Base name must include %d or %x'); const created=[]; for(let i=1;i<=count;i++){ const name=base.replace(/%d/g,String(i)).replace(/%x/g,i.toString(16).toUpperCase()); if(state.groups.find(g=>g.name===name)) continue; const dup=JSON.parse(JSON.stringify(state.sel)); dup.id=uid(); dup.name=name; if(structureOnly){ (function clearDevs(sgs){ (sgs||[]).forEach(s=>{ s.devices=[]; clearDevs(s.subGroups); }); })(dup.subGroups);} state.groups.push(dup); created.push(dup.id);} state.lastAction={type:'duplicate',ids:created}; renderGroups(); dlg('#dlgDuplicate','close'); };
  $('#btnUndo').onclick=()=>{ const a=state.lastAction; if(!a) return; if(a.type==='create') state.groups=state.groups.filter(g=>g.id!==a.id); if(a.type==='duplicate') state.groups=state.groups.filter(g=>!a.ids.includes(g.id)); state.lastAction=null; state.sel=null; renderGroups(); $('#editor').style.display='none'; $('#editorEmpty').style.display=''; };

  // Import/Export dialog
  $('#btnIO').onclick=()=> dlg('#dlgIO','open'); $('#ioClose').onclick=()=> dlg('#dlgIO','close');
  $('#ioImportConfig').onclick=async()=>{ const f=$('#ioConfigFile').files[0]; if(!f) return alert('Choose a .json config file'); try{ const txt=await f.text(); const obj=JSON.parse(txt); if(!Array.isArray(obj.groups)) throw new Error('groups[] missing'); function mapSG(sg){ return { name:sg.name||'', template:sg.template||'', devices:(sg.devices||[]).map(d=>({address:String(d.address||'').trim()})), subGroups:(sg.subGroups||[]).map(mapSG) }; }
      state.groups = obj.groups.map(g=>({ id:uid(), name:String(g.name||'').trim(), inError:Number(g.inError||50), errorPositions:Number(g.errorPositions||2), sorts:g.sorts||{p:'Priority',s:'State',t:'Date (Newest First)'}, useGlobalSettings:g.useGlobalSettings!==false, localSettings:g.localSettings||{orientation:'Vertical',cellSpacing:8,latching:true,itemSize:320,showAddr:true,showPrio:true,showTs:true}, subGroups:(g.subGroups||[]).map(mapSG) }));
      state.templates = Array.isArray(obj.templates)? obj.templates.map(t=>({ name:String(t.name||'').trim(), mode:(t.mode==='all'?'all':'perUnit'), headers:Array.isArray(t.headers)?t.headers.map(String):[], units:Array.isArray(t.units)?t.units.map(String):[] })) : state.templates;
      if(obj.projectVars){ Object.assign(state.projectVars,{ orientation: obj.projectVars.orientation ?? state.projectVars.orientation, cellSpacing: Number(obj.projectVars.cellSpacing ?? state.projectVars.cellSpacing), latching: !!obj.projectVars.latching, itemSize: Number(obj.projectVars.itemSize ?? state.projectVars.itemSize), showAddr: obj.projectVars.showAddr ?? state.projectVars.showAddr, showPrio: obj.projectVars.showPrio ?? state.projectVars.showPrio, showTs: obj.projectVars.showTs ?? state.projectVars.showTs }); }
      if(obj.master){ Object.assign(state.master,obj.master); }
      renderGroups(); if(state.sel) openEditor(state.sel); alert('Config import complete.'); }
    catch(e){ alert('Import failed: '+e.message); } };
  $('#ioImportTemplates').onclick=async()=>{ const files=$('#ioTemplateFiles').files; if(!files || files.length===0) return alert('Choose one or more .tmpl files'); let imported=0, skipped=0; for(const f of files){ try{ const name=f.name; const txt=await f.text(); const headers=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); if(headers.length===0) { skipped++; continue; } const idx=state.templates.findIndex(t=>t.name===name); const tpl={ name, mode:'all', headers, units:[] }; if(idx>=0) state.templates[idx]=tpl; else state.templates.push(tpl); imported++; }catch(e){ skipped++; } } alert(`Templates imported: ${imported}${skipped?` (skipped ${skipped})`:''}`); if($('#dlgTemplates').open) renderTplList(); };
  $('#ioExportRun').onclick=()=>{ function cleanSG(sg){ return { name: sg.name, template: sg.template, devices:(sg.devices||[]).map(d=>({address:d.address})), subGroups:(sg.subGroups||[]).map(cleanSG) }; } const payload=JSON.stringify({ version:9, master:state.master, projectVars:state.projectVars, templates: state.templates, groups: state.groups.map(g=> ({ name:g.name, inError:g.inError, errorPositions:g.errorPositions, sorts:g.sorts, useGlobalSettings:g.useGlobalSettings!==false, localSettings:g.localSettings, subGroups:(g.subGroups||[]).map(cleanSG) })) }, null, 2); download('penalty_box_config.json', payload); };

  // --- Pick Template dialog ---
  let tplPickSel=null; // selected name
  $('#sgPickTemplate').onclick=()=>{ openPickTemplateDialog(); };
  function openPickTemplateDialog(){ $('#tplPickSearch').value=''; const includeProject= (state.mapView==='Running'); $('#tplIncludeProject').checked = includeProject; $('#tplIncludeProject').disabled = (state.mapView!=='Running'); renderPickTemplateList(); dlg('#dlgPickTemplate','open'); }
  $('#tplIncludeProject').addEventListener('change',renderPickTemplateList);
  $('#tplRefreshProject').onclick=()=>{ fetchProjectTemplates(); renderPickTemplateList(); };
  $('#tplPickCancel').onclick=()=> dlg('#dlgPickTemplate','close');
  $('#tplPickChoose').onclick=()=>{ if(!tplPickSel) return alert('Select a template'); $('#sgTemplate').value = tplPickSel; dlg('#dlgPickTemplate','close'); };
  $('#tplPickSearch').addEventListener('input',renderPickTemplateList);

  function fetchProjectTemplates(){ if(state.mapView!=='Running'){ alert('MapView is not Running. Cannot fetch from project.'); return; } 
    // Simulated fetch: merge a small demo set; in a real tool this would call MapView service
    const demo=[ {name:'Project_SystemHealth.tmpl', mode:'all', headers:['RESTARTED_AT','UPTIME','VERSION','NAME','IPADDRESS']}, {name:'Project_Network.tmpl', mode:'all', headers:['IPADDRESS','LATENCY','PACKET_LOSS'] } ];
    // de-dup by name
    demo.forEach(t=>{ const i=state.projectTemplates.findIndex(x=>x.name===t.name); if(i>=0) state.projectTemplates[i]=t; else state.projectTemplates.push(t); });
    alert('Fetched templates from Project (simulated).');
  }

  function renderPickTemplateList(){ const box=$('#tplPickList'); box.innerHTML=''; const q=($('#tplPickSearch').value||'').toLowerCase(); const useProject=$('#tplIncludeProject').checked; const rows=[]; if(useProject) state.projectTemplates.forEach(t=> rows.push({name:t.name, src:'Project'})); state.templates.forEach(t=> rows.push({name:t.name, src:'Tool'})); // de-dup by (name,src) while allowing same name from both
    const uniq=[]; const seen=new Set(); rows.forEach(r=>{ const key=r.name+'|'+r.src; if(!seen.has(key) && (!q || r.name.toLowerCase().includes(q))) { seen.add(key); uniq.push(r); } }); if(uniq.length===0){ box.innerHTML='<div class="muted small">No templates found. '+(useProject?'':'(Tip: enable "Include Project" if MapView is Running)')+'</div>'; tplPickSel=null; return; }
    uniq.sort((a,b)=> a.name.localeCompare(b.name) || a.src.localeCompare(b.src)); uniq.forEach(r=>{ const div=document.createElement('div'); div.className='itm'; div.innerHTML=`<span>${escapeHtml(r.name)}</span><span class='src'>${r.src}</span>`; div.dataset.name=r.name; div.dataset.src=r.src; div.onclick=()=>{ box.querySelectorAll('.itm').forEach(n=> n.style.background=''); div.style.background='#1b2336'; tplPickSel=r.name; }; div.ondblclick=()=>{ tplPickSel=r.name; $('#tplPickChoose').click(); }; box.appendChild(div); }); }

  // --- Generate & Apply ---
  $('#btnGenerate').onclick=()=> dlg('#dlgGenerate','open');
  $('#genCancel').onclick=()=> dlg('#dlgGenerate','close');
  $('#genOk').onclick=()=>{ const ids=state.groups.map(g=>`EM::${g.name}`); const dups=ids.filter((id,idx)=> ids.indexOf(id)!==idx); if(dups.length){ alert('Duplicate EM identifiers: '+[...new Set(dups)].join(', ')); return; } alert('Generation successful (mock). Behaviours would be written to Penalty_Box.globalx and screens created, then pushed to Project.'); dlg('#dlgGenerate','close'); };

  function syncPvPanelFromState(){ $('#g_pvOrientation').value=state.projectVars.orientation; $('#g_pvCellSpacing').value=state.projectVars.cellSpacing; $('#g_pvLatching').checked=state.projectVars.latching; $('#g_pvItemSize').value=state.projectVars.itemSize; $('#g_pvShowAddr').checked=state.projectVars.showAddr; $('#g_pvShowPrio').checked=state.projectVars.showPrio; $('#g_pvShowTs').checked=state.projectVars.showTs; $('#g_masterSlots').value=state.master.errorPositions; }
  function applyPvPanelToState(){ state.projectVars.orientation=$('#g_pvOrientation').value; state.projectVars.cellSpacing=Number($('#g_pvCellSpacing').value); state.projectVars.latching=$('#g_pvLatching').checked; state.projectVars.itemSize=Number($('#g_pvItemSize').value); state.projectVars.showAddr=$('#g_pvShowAddr').checked; state.projectVars.showPrio=$('#g_pvShowPrio').checked; state.projectVars.showTs=$('#g_pvShowTs').checked; state.master.errorPositions=Number($('#g_masterSlots').value); }

  $('#btnApplyPV').onclick=()=>{ // Apply globals and also push templates (new or changed)
    applyPvPanelToState(); if(state.sel) openEditor(state.sel);
    const changes = diffTemplatesSinceLastPush();
    const msg = [
      'Applied Global Settings.',
      '(Mock) Would now generate Penalty_Box.globalx and all MapView screens, and push to Project.',
      `Templates to write: ${changes.toWrite.length} (${changes.newCount} new, ${changes.updatedCount} updated)`
    ];
    if(changes.toWrite.length){ msg.push(' - '+changes.toWrite.slice(0,8).join(', ')+(changes.toWrite.length>8?' …':'')); }
    alert(msg.join('\n'));
    markTemplatesPushed();
  };

  function diffTemplatesSinceLastPush(){ const toWrite=[]; let newCount=0, updatedCount=0; state.templates.forEach(t=>{ const sig=tplSig(t); const prev = state.lastPushedTemplates[t.name]; if(!prev){ toWrite.push(t.name); newCount++; } else if(prev!==sig){ toWrite.push(t.name); updatedCount++; } }); return { toWrite, newCount, updatedCount }; }
  function markTemplatesPushed(){ state.templates.forEach(t=>{ state.lastPushedTemplates[t.name]=tplSig(t); }); }

  $('#btnResetPV').onclick=()=>{ state.projectVars={ orientation:'Vertical', cellSpacing:8, latching:true, itemSize:320, showAddr:true, showPrio:true, showTs:true }; state.master.errorPositions=10; syncPvPanelFromState(); if(state.sel) openEditor(state.sel); };

  // Settings mode & local settings binding
  $('#modeGlobal').addEventListener('change',()=>{ if(!state.sel) return; state.sel.useGlobalSettings=true; setLocalControlsEnabled(false); openEditor(state.sel); });
  $('#modeLocal').addEventListener('change',()=>{ if(!state.sel) return; state.sel.useGlobalSettings=false; setLocalControlsEnabled(true); openEditor(state.sel); });
  function bindLocalSetting(id,key,type='value'){ const el=$('#'+id); el.addEventListener(type==='checked'?'change':'input', ()=>{ if(!state.sel) return; if(!state.sel.localSettings) state.sel.localSettings={...state.projectVars}; if(id==='lvItemSize' || id==='lvCellSpacing') state.sel.localSettings[key]=Number(el.value); else if(type==='checked') state.sel.localSettings[key]=el.checked; else state.sel.localSettings[key]=el.value; renderPreview(state.sel); }); }
  bindLocalSetting('lvOrientation','orientation'); bindLocalSetting('lvCellSpacing','cellSpacing'); bindLocalSetting('lvLatching','latching','checked'); bindLocalSetting('lvItemSize','itemSize'); bindLocalSetting('lvShowAddr','showAddr','checked'); bindLocalSetting('lvShowPrio','showPrio','checked'); bindLocalSetting('lvShowTs','showTs','checked');

  // Sub-group editing (nested)
  let editingCtx=null; $('#btnAddSubGroup').onclick=()=>{ if(!state.sel) return alert('Select a favourite first'); const node={ name:'', template:'', devices:[], subGroups:[], __path:[] }; editingCtx={ parentArray: state.sel.subGroups, index:-1, node }; openSubGroupDialog(); };
  function editSubGroup(idx){ editingCtx={ parentArray: state.sel.subGroups, index: idx, node: JSON.parse(JSON.stringify(state.sel.subGroups[idx])) }; if(!editingCtx.node.__path) editingCtx.node.__path=[editingCtx.node.name]; openSubGroupDialog(); }
  function openSubGroupDialog(){ const d=editingCtx.node; $('#sgName').value=d.name||''; $('#sgTemplate').value=d.template||''; updateFavPathField(); renderSgDevs(); renderSgChildren(); dlg('#dlgSubGroup','open'); }
  function updateFavPathField(){ const d=editingCtx.node; const pathParts=(d.__path&&d.__path.length? d.__path : [d.name]).filter(Boolean); $('#sgFav').value=autoFavPath(state.sel.name, pathParts).join('/'); }
  function renderSgDevs(){ const tbody=$('#sgDevTable tbody'); tbody.innerHTML=''; (editingCtx.node.devices||[]).forEach((dv,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(dv.address)}</td><td><span class='link' data-del='${i}'>Remove</span></td>`; tbody.appendChild(tr); }); tbody.onclick=e=>{ if(e.target.matches('[data-del]')){ const i=+e.target.getAttribute('data-del'); editingCtx.node.devices.splice(i,1); renderSgDevs(); } } }
  function renderSgChildren(){ const host=$('#sgChildren'); host.innerHTML=''; const children=editingCtx.node.subGroups||[]; if(children.length===0){ host.innerHTML='<div class="muted small">No child sub-groups yet.</div>'; return; } const table=document.createElement('table'); table.className='table'; table.innerHTML='<thead><tr><th>Name</th><th>Alarm Path (auto)</th><th></th><th></th></tr></thead><tbody></tbody>'; const tbody=table.querySelector('tbody'); children.forEach((c,idx)=>{ if(!c.__path) c.__path=[...(editingCtx.node.__path && editingCtx.node.__path.length? editingCtx.node.__path : [editingCtx.node.name]), c.name]; const tr=document.createElement('tr'); const fav=autoFavPath(state.sel.name, c.__path).join('/'); tr.innerHTML=`<td><input type='text' value='${escapeHtml(c.name||'')}' data-child-name='${idx}'/></td><td>${escapeHtml(fav)}</td><td><span class='link' data-child-edit='${idx}'>Edit</span></td><td><span class='link' data-child-del='${idx}'>Delete</span></td>`; tbody.appendChild(tr); }); host.appendChild(table); host.oninput=e=>{ const idx=e.target.getAttribute('data-child-name'); if(idx!=null){ const i=+idx; const input=e.target; editingCtx.node.subGroups[i].name=input.value; const basePath=editingCtx.node.__path && editingCtx.node.__path.length? editingCtx.node.__path : [editingCtx.node.name]; editingCtx.node.subGroups[i].__path=[...basePath, editingCtx.node.subGroups[i].name]; const pathCell=input.parentElement.nextElementSibling; pathCell.textContent=autoFavPath(state.sel.name, editingCtx.node.subGroups[i].__path).join('/'); }}; host.onclick=e=>{ const editIdx=e.target.getAttribute('data-child-edit'); if(editIdx!=null){ const i=+editIdx; const childNode=JSON.parse(JSON.stringify(editingCtx.node.subGroups[i])); editingCtx={ parentArray: editingCtx.node.subGroups, index:i, node: childNode }; openSubGroupDialog(); return; } const delIdx=e.target.getAttribute('data-child-del'); if(delIdx!=null){ editingCtx.node.subGroups.splice(+delIdx,1); renderSgChildren(); } } }
  $('#sgAddChild').onclick=()=>{ const basePath=editingCtx.node.__path && editingCtx.node.__path.length? editingCtx.node.__path : [editingCtx.node.name]; const child={ name:'New Sub-group', devices:[], subGroups:[], __path:[...basePath,'New Sub-group'] }; if(!editingCtx.node.subGroups) editingCtx.node.subGroups=[]; editingCtx.node.subGroups.push(child); renderSgChildren(); };
  $('#sgAddDev').onclick=()=>{ const a=$('#sgDevAddr').value.trim(); if(!a) return; editingCtx.node.devices.push({address:a}); $('#sgDevAddr').value=''; renderSgDevs(); };
  $('#sgPickAddr').onclick=()=> alert('Address picker would open here to query Monitoring Service (not implemented).');
  $('#sgViewTemplate').onclick=()=>{ const name=$('#sgTemplate').value.trim(); if(!name) return alert('No template set.'); const tpl = [...state.templates, ...state.projectTemplates].find(t=>t.name===name); if(!tpl) return alert('Template not found in Tool or Project.'); alert(`Template: ${tpl.name}\nSource: ${ state.templates.some(t=>t.name===name)?'Tool': (state.projectTemplates.some(t=>t.name===name)?'Project':'?') }\nMode: ${tpl.mode}\nHeaders:\n- ${tpl.headers.join('\n- ')}`); };

  $('#sgCancel').onclick=()=> dlg('#dlgSubGroup','close');
  $('#sgOk').onclick=()=>{ const d=editingCtx.node; d.name=$('#sgName').value.trim(); d.template=$('#sgTemplate').value.trim(); if(!d.__path||d.__path.length===0) d.__path=[d.name]; else d.__path=[...d.__path.slice(0,-1), d.name]; if(editingCtx.index===-1) editingCtx.parentArray.push(d); else editingCtx.parentArray[editingCtx.index]=d; dlg('#dlgSubGroup','close'); renderSubGroups(state.sel); renderPreview(state.sel); };

  // Templates manager (same as v8 with file import)
  $('#btnTemplates').onclick=()=>{ renderTplList(); dlg('#dlgTemplates','open'); }; $('#tplClose').onclick=()=> dlg('#dlgTemplates','close');
  function renderTplList(){ const box=$('#tplList'); box.innerHTML=''; state.templates.forEach((t,i)=>{ const div=document.createElement('div'); div.className='itm'; div.innerHTML=`<span>${escapeHtml(t.name)}</span><span class='src'>Tool</span>`; div.dataset.idx=i; box.appendChild(div); }); box.onclick=e=>{ const el=e.target.closest('.itm'); if(!el) return; const t=state.templates[el.dataset.idx]; $('#tplQuickView').textContent=`Name: ${t.name}\nMode: ${t.mode}\nHeaders:\n- ${t.headers.join('\n- ')}`; box.querySelectorAll('.itm').forEach(n=> n.style.background=''); el.style.background='#1b2336'; box.dataset.sel=el.dataset.idx; } }
  $('#tplCreate').onclick=()=> openTplEditor(); $('#tplEdit').onclick=()=>{ const i=Number($('#tplList').dataset.sel||'-1'); if(isNaN(i)||i<0) return alert('Select a template to edit.'); openTplEditor(state.templates[i], i); };
  $('#tplDelete').onclick=()=>{ const i=Number($('#tplList').dataset.sel||'-1'); if(isNaN(i)||i<0) return alert('Select a template to delete.'); if(!confirm('Delete template?')) return; state.templates.splice(i,1); renderTplList(); $('#tplQuickView').textContent='Select a template to view its headers.'; };
  $('#tplExport').onclick=()=>{ if(state.templates.length===0) return alert('No templates to export.'); download('penalty_box_templates.json', JSON.stringify(state.templates, null, 2)); };
  $('#tplImportFiles').onclick=async()=>{ const files=$('#tplFiles').files; if(!files || files.length===0) return alert('Choose one or more .tmpl files'); let imported=0, skipped=0; for(const f of files){ try{ const name=f.name; const txt=await f.text(); const headers=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); if(headers.length===0) { skipped++; continue; } const idx=state.templates.findIndex(t=>t.name===name); const tpl={ name, mode:'all', headers, units:[] }; if(idx>=0) state.templates[idx]=tpl; else state.templates.push(tpl); imported++; }catch(_){ skipped++; } } alert(`Templates imported: ${imported}${skipped?` (skipped ${skipped})`:''}`); renderTplList(); };

  // Template editor
  let tplEditingIndex=-1; let tplUnits=[]; let tplSelected=[]; function openTplEditor(t=null,index=-1){ tplEditingIndex=index; $('#tplEdTitle').textContent=t?'Edit Template':'Create Template'; $('#tplName').value=t?t.name:''; (t && t.mode==='all'? $('#tplModeAll'):$('#tplModePerUnit')).checked=true; tplUnits=t?(t.units||[]):[]; tplSelected=t?(t.headers||[]):[]; renderTplUnits(); renderTplLists(); dlg('#dlgTplEditor','open'); }
  function renderTplUnits(){ const host=$('#tplUnits'); host.innerHTML=''; if(tplUnits.length===0){ host.innerHTML='<span class="muted small">No units. Add addresses or use current group\'s devices.</span>'; return; } tplUnits.forEach((u,i)=>{ const sp=document.createElement('span'); sp.className='pill-tag'; sp.textContent=u; sp.title='Click to remove'; sp.onclick=()=>{ tplUnits.splice(i,1); renderTplUnits(); renderTplLists(); }; host.appendChild(sp); }); }
  function availableHeaders(){ const mode=$('#tplModeAll').checked?'all':'perUnit'; if(mode==='all') return HEADER_CATALOG.slice(); const set=new Set(); if(tplUnits.length===0){ return HEADER_CATALOG.slice(0,Math.ceil(HEADER_CATALOG.length/2)); } tplUnits.forEach(u=> headersForUnit(u).forEach(h=> set.add(h))); return Array.from(set); }
  function renderTplLists(){ const availBox=$('#tplAvail'); const selBox=$('#tplSelected'); availBox.innerHTML=''; selBox.innerHTML=''; const avail=availableHeaders().filter(h=>!tplSelected.includes(h)).sort(); tplSelected=Array.from(new Set(tplSelected)).sort(); avail.forEach(h=>{ const d=document.createElement('div'); d.className='itm'; d.textContent=h; d.onclick=()=> d.classList.toggle('sel'); availBox.appendChild(d); }); tplSelected.forEach(h=>{ const d=document.createElement('div'); d.className='itm'; d.textContent=h; d.onclick=()=> d.classList.toggle('sel'); selBox.appendChild(d); }); $('#tplPerUnitArea').style.display=$('#tplModeAll').checked?'none':'block'; }
  $('#tplModeAll').addEventListener('change',renderTplLists); $('#tplModePerUnit').addEventListener('change',renderTplLists);
  $('#tplAddUnit').onclick=()=>{ const a=$('#tplUnitAddr').value.trim(); if(!a) return; if(!tplUnits.includes(a)) tplUnits.push(a); $('#tplUnitAddr').value=''; renderTplUnits(); renderTplLists(); };
  $('#tplUseGroupUnits').onclick=()=>{ if(!state.sel) return alert('Select a favourite first'); const addrs=[]; (function collect(sgs){ (sgs||[]).forEach(s=>{ (s.devices||[]).forEach(d=> addrs.push(d.address)); collect(s.subGroups); }); })(state.sel.subGroups); addrs.forEach(a=>{ if(!tplUnits.includes(a)) tplUnits.push(a); }); renderTplUnits(); renderTplLists(); };
  $('#tplClearUnits').onclick=()=>{ tplUnits=[]; renderTplUnits(); renderTplLists(); };
  $('#tplAddHdr').onclick=()=>{ const chosen=Array.from($('#tplAvail').querySelectorAll('.itm.sel')).map(el=>el.textContent); chosen.forEach(h=>{ if(!tplSelected.includes(h)) tplSelected.push(h); }); renderTplLists(); };
  $('#tplRemoveHdr').onclick=()=>{ const chosen=Array.from($('#tplSelected').querySelectorAll('.itm.sel')).map(el=>el.textContent); tplSelected=tplSelected.filter(h=>!chosen.includes(h)); renderTplLists(); };
  $('#tplEdCancel').onclick=()=> dlg('#dlgTplEditor','close');
  $('#tplEdSave').onclick=()=>{ const name=$('#tplName').value.trim(); if(!name) return alert('Enter template name'); if(!/\.tmpl$/i.test(name)) { if(!confirm('Template names normally end with .tmpl. Save anyway?')) return; } const mode=$('#tplModeAll').checked?'all':'perUnit'; const tpl={ name, mode, headers:tplSelected.slice(), units:(mode==='perUnit'?tplUnits.slice():[]) }; if(tplEditingIndex>=0) state.templates[tplEditingIndex]=tpl; else state.templates.push(tpl); dlg('#dlgTplEditor','close'); if($('#dlgTemplates').open) renderTplList(); };

  // Save/Delete group
  $('#btnDeleteGroup').onclick=()=>{ if(!state.sel) return; if(!confirm('Delete favourite '+state.sel.name+'?')) return; state.groups=state.groups.filter(g=>g!==state.sel); state.sel=null; renderGroups(); $('#editor').style.display='none'; $('#editorEmpty').style.display=''; };
  $('#btnSaveGroup').onclick=()=>{ if(!state.sel) return; state.sel.name=$('#groupName').value.trim(); state.sel.inError=Number($('#inErrorState').value); state.sel.errorPositions=Number($('#errorPositions').value); state.sel.sorts={ p:$('#primarySort').value, s:$('#secondarySort').value, t:$('#tertiarySort').value }; renderGroups($('#searchGroups').value); openEditor(state.sel); };

  $('#groupName').addEventListener('input',()=>{ if(!state.sel) return; $('#groupIdentifier').textContent='EM::'+$('#groupName').value.trim(); });
  $('#searchGroups').addEventListener('input',e=> renderGroups(e.target.value));

  // Init
  syncPvPanelFromState(); renderGroups(); updateMvBadge();

  // Sample data
  $('#btnLoadSample').onclick=()=>{ if(!confirm('Load sample Channel 1-3 with nested sub-groups & templates? This replaces current favourites.')) return; state.groups=[ { id:uid(), name:'Channel 1', inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, useGlobalSettings:true, localSettings:{orientation:'Vertical',cellSpacing:8,latching:true,itemSize:320,showAddr:true,showPrio:true,showTs:true}, subGroups:[ { name:'Servers', template:'Dave.tmpl', devices:[{address:'F110:01:01'},{address:'F110:01:02'}], subGroups:[{ name:'Compute', devices:[{address:'F110:01:AA'}] }] }, { name:'Processors', template:'Mike.tmpl', devices:[{address:'F110:01:03'},{address:'F110:01:04'}], subGroups:[] } ]}, { id:uid(), name:'Channel 2', inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, useGlobalSettings:false, localSettings:{orientation:'Horizontal',cellSpacing:12,latching:false,itemSize:300,showAddr:false,showPrio:true,showTs:true}, subGroups:[ { name:'Servers', template:'Dave.tmpl', devices:[{address:'F110:01:05'},{address:'F110:01:06'}], subGroups:[{ name:'Video' }] }, { name:'Processors', template:'', devices:[{address:'F110:01:07'},{address:'F110:01:08'}], subGroups:[] } ]}, { id:uid(), name:'Channel 3', inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, useGlobalSettings:true, localSettings:{orientation:'Vertical',cellSpacing:8,latching:true,itemSize:320,showAddr:true,showPrio:true,showTs:true}, subGroups:[ { name:'Servers', template:'', devices:[{address:'F110:01:09'},{address:'F110:01:0A'}], subGroups:[] }, { name:'Processors', template:'', devices:[{address:'F110:01:0B'},{address:'F110:01:0D'}], subGroups:[] } ]} ]; state.templates=[ { name:'Dave.tmpl', mode:'all', headers:['CPU','HEALTH','NETWORK'] }, { name:'Mike.tmpl', mode:'perUnit', units:['F110:01:03','F110:01:04'], headers:['STREAM_STATE','INPUT_LOCK'] } ]; state.sel=state.groups[0]; renderGroups(); openEditor(state.sel); };
</script>
</body>
</html>
