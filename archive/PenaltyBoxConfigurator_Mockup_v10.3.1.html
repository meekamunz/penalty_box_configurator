
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Penalty Box Configurator – Interactive Mockup (v10.3.1, API‑wired)</title>
<style>
  :root { --bg:#0f1115; --panel:#171a21; --panel-2:#1f2430; --text:#e6e9ef; --muted:#a5adcb; --accent:#7aa2f7; --ok:#73daca; --warn:#e0af68; --err:#f7768e; --badge:#2b3245; --btn:#2d3344; --btn-h:#3b435a; --link:#86aaec; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid #222635;background:#11141a;position:sticky;top:0;z-index:3}
  header h1{font-size:18px;margin:0;font-weight:600;letter-spacing:.3px}
  .toolbar{display:flex;gap:8px;margin-left:auto}
  button,.btn{background:var(--btn);color:var(--text);border:1px solid #2b3040;border-radius:6px;padding:8px 10px;cursor:pointer;font-size:13px}
  button:hover,.btn:hover{background:var(--btn-h)}
  .btn-primary{background:#26406b;border-color:#2f4d81}
  .btn-primary:hover{background:#315587}
  .btn-danger{background:#5a2330;border-color:#6b2a39}
  .btn-danger:hover{background:#6b2a39}
  .layout{display:grid;grid-template-columns:280px 1fr 380px;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid #22283a;border-radius:10px;padding:12px}
  .panel h2{font-size:14px;margin:0 0 8px 0;font-weight:600;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:6px;max-height:calc(100vh - 190px);overflow:auto;padding-right:4px}
  .list-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:var(--panel-2);border:1px solid #2b3245;cursor:pointer}
  .list-item:hover{border-color:#3a445f}
  .list-item.active{outline:2px solid var(--accent)}
  .badge{padding:2px 6px;border-radius:999px;font-size:11px;background:var(--badge);color:var(--muted)}
  .badge.ok{background:#13342f;color:var(--ok)}
  .badge.warn{background:#3c3017;color:var(--warn)}
  .badge.err{background:#3b1b23;color:var(--err)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;color:var(--muted)}
  select,input[type="text"],input[type="number"],textarea{background:#0f1320;color:var(--text);border:1px solid #2b3245;border-radius:6px;padding:8px;font-size:13px}
  input[type="checkbox"]{transform:translateY(1px)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .section{border-top:1px dashed #2b3245;margin-top:10px;padding-top:10px}
  .muted{color:var(--muted);font-size:12px}
  .pill{padding:6px 8px;background:#0f1320;border:1px solid #2b3245;border-radius:6px;font-size:12px}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:6px;align-items:center}
  .status-item{background:var(--panel-2);border:1px solid #2b3245;border-radius:8px;padding:8px;margin-bottom:8px}
  .status-item .title{font-weight:600;font-size:13px}
  .footer{text-align:center;color:var(--muted);font-size:12px;padding:12px}
  .search{width:100%}
  .toolbar-inline{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .stack{display:flex;flex-direction:column;gap:8px}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{border-bottom:1px solid #2b3245;padding:6px 8px;text-align:left;vertical-align:top}
  .table th{color:var(--muted);font-weight:600}
  .link{color:var(--link);cursor:pointer;text-decoration:underline}
  dialog{border:1px solid #2b3245;background:var(--panel);color:var(--text);border-radius:10px;padding:0;width:1000px;max-width:96vw}
  dialog header{padding:12px 14px;border-bottom:1px solid #2b3245;background:var(--panel-2)}
  dialog .content{padding:12px}
  dialog .actions{padding:12px;border-top:1px solid #2b3245;display:flex;gap:8px;justify-content:flex-end}
  .small{font-size:12px}
  .code{background:#0b0f1a;border:1px solid #20283e;padding:8px;border-radius:8px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#cbd5f7}
  .listbox{height:240px; width:100%; background:#0f1320; border:1px solid #2b3245; border-radius:6px; padding:6px; overflow:auto;}
  .listbox .itm{padding:6px 8px; border-bottom:1px dashed #232a3d; cursor:pointer}
  .listbox .itm:hover{background:#151a2a}
  .pill-tag{display:inline-block; padding:2px 6px; margin:2px; border-radius:999px; background:#0f1320; border:1px solid #2b3245; font-size:12px}
  .state-pill{display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; margin-left:6px; border:1px solid #2b3245}
  .state-ok{background:#0f1a12; color:#73daca; border-color:#1e3b2d}
  .state-warn{background:#2a2512; color:#e0af68; border-color:#4a3f1e}
  .state-fail{background:#2a1418; color:#f7768e; border-color:#5b2730}
</style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Penalty Box Configurator – Mockup <span class="muted">v10.3.1</span></h1>
      <span class="badge" id="licenseBadge">License: <strong>Missing</strong></span>
      <span class="badge" id="mvBadge"><span class="dot" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#666;margin-right:6px"></span><strong>MapView:</strong> <span id="mvText">Stopped</span></span>
      <label class="row small" style="margin-left:4px">State
        <select id="mvSelect">
          <option>Running</option>
          <option>Starting</option>
          <option selected>Stopped</option>
          <option>Error</option>
        </select>
      </label>
    </div>
    <div class="stack">
      <div class="row" style="gap:8px; align-items:flex-end; flex-wrap:wrap">
        <label style="flex:1"><span class="muted">Alarm API Base</span><input id="cfgApiBase" type="text" value="http://127.0.0.1:9099/alarmapi/v1"/></label>
        <label><span class="muted">Subscription Mode</span><select id="cfgSubMode"><option value="pull" selected>pull</option><option value="push">push</option></select></label>
        <button id="btnPing">Ping</button>
        <button id="btnSubscribe">Subscribe</button>
        <button id="btnStopSub">Stop</button>
        <span class="badge" id="subBadge">No subscription</span>
      </div>
      <div class="toolbar">
        <button id="btnCreate">Create</button>
        <button id="btnDuplicate">Duplicate</button>
        <button id="btnUndo">Undo</button>
        <button id="btnIO">Import/Export</button>
        <button id="btnTemplates">Templates</button>
        <button id="btnTemplateBrowser">Template Browser</button>
        <button id="btnGenerate" class="btn-primary">Generate</button>
        <button id="btnLoadSample">Load Sample</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <div class="panel">
      <div class="toolbar-inline">
        <h2>Favourites</h2>
        <input class="search" id="searchGroups" placeholder="Search favourites..." />
      </div>
      <div class="list" id="groupList"></div>
    </div>

    <div class="panel" id="editorPanel">
      <h2>Group Editor</h2>
      <div class="stack" id="editorEmpty">
        <div class="muted">Select a favourite (alarm group) to edit, or click <strong>Create</strong>.</div>
      </div>
      <div class="stack" id="editor" style="display:none;">
        <div class="grid-3">
          <div class="stack">
            <label>Group Name</label>
            <input id="groupName" type="text" />
          </div>
          <div class="stack">
            <label>MbyE Identifier</label>
            <div class="pill" id="groupIdentifier">EM::</div>
          </div>
          <div class="stack">
            <label>Settings Mode</label>
            <div class="row small">
              <label><input type="radio" name="settingsMode" id="modeGlobal" value="global"> Global Settings</label>
              <label><input type="radio" name="settingsMode" id="modeLocal" value="local"> Local Settings</label>
            </div>
          </div>
        </div>

        <!-- Group-level devices/alarms -->
        <div class="section">
          <div class="row" style="justify-content: space-between;align-items:center;">
            <h3 style="margin:0;font-size:13px;color:var(--muted)">Group-level Devices & Alarms</h3>
            <div class="row">
              <input id="grpDevAddr" type="text" placeholder="Device path (e.g., F110:01:01 or Favourites/...)"/>
              <input id="grpAlarmName" type="text" placeholder="Alarm name (optional, e.g., POWER_USAGE)"/>
              <button id="grpAddDev">Add</button>
              <button id="grpPickAddr">Alarm Picker…</button>
            </div>
          </div>
          <table class="table" id="grpDevTable">
            <thead><tr><th>Device Path</th><th>Alarm</th><th>Alarm Path</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="muted small">Supports RollCall (e.g., <code>F110:01:02</code>) and hierarchical favourites (e.g., <code>Favourites/Playout Channels/Channel 1</code>).</div>
        </div>

        <div class="section">
          <div class="row" style="justify-content: space-between;">
            <h3 style="margin:0;font-size:13px;color:var(--muted)">Sub-groups</h3>
            <button id="btnAddSubGroup">Add Sub-group</button>
          </div>
          <table class="table" id="subGroupTable">
            <thead>
              <tr><th>Name</th><th>Alarm Path</th><th>Template</th><th>Devices/Alarms</th><th>Children</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="section grid-3">
          <div class="stack">
            <label>In Error State</label>
            <select id="inErrorState">
              <option value="50">Minor / WARN (50)</option>
              <option value="75">Major (75)</option>
              <option value="100">Critical / FAIL (100)</option>
            </select>
          </div>
          <div class="stack">
            <label>Error Positions (top-N)</label>
            <input id="errorPositions" type="number" min="1" max="50" value="2" />
          </div>
          <div class="stack">
            <label>Sorting</label>
            <div class="row">
              <select id="primarySort"><option>Priority</option><option>State</option><option>Date (Newest First)</option><option>Address</option></select>
              <select id="secondarySort"><option>State</option><option>Priority</option><option>Date (Newest First)</option><option>Address</option></select>
              <select id="tertiarySort"><option>Date (Newest First)</option><option>Priority</option><option>State</option><option>Address</option></select>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="grid-2">
            <div class="stack">
              <label>Local Settings (overrides Global when selected)</label>
              <div class="kv">
                <div>Layout Orientation</div>
                <select id="lvOrientation"><option>Vertical</option><option>Horizontal</option></select>
                <div>Cell Spacing</div>
                <input id="lvCellSpacing" type="number" min="0" max="64" value="8" />
                <div>Enable Latching</div>
                <input id="lvLatching" type="checkbox" checked />
                <div>Item Size</div>
                <input id="lvItemSize" type="number" value="320"/>
                <div>Show Address</div>
                <div class="row"><input id="lvShowAddr" type="checkbox" checked/><label for="lvShowAddr">Show Address</label></div>
                <div>Show Priority</div>
                <div class="row"><input id="lvShowPrio" type="checkbox" checked/><label for="lvShowPrio">Show Priority</label></div>
                <div>Show Timestamp</div>
                <div class="row"><input id="lvShowTs" type="checkbox" checked/><label for="lvShowTs">Show Timestamp</label></div>
              </div>
            </div>
            <div class="stack">
              <label>Identifier & Preview</label>
              <div class="code" id="previewCode">// Behaviour preview will appear here</div>
            </div>
          </div>
        </div>

        <div class="section">
          <button class="btn-primary" id="btnSaveGroup">Save Group</button>
          <button class="btn-danger" id="btnDeleteGroup">Delete Group</button>
        </div>
      </div>
    </div>

    <div class="panel right-form">
      <h2>Global Settings</h2>
      <div class="kv">
        <div>Layout Orientation</div>
        <select id="g_pvOrientation"><option>Vertical</option><option>Horizontal</option></select>
        <div>Cell Spacing</div>
        <input id="g_pvCellSpacing" type="number" min="0" max="64" value="8" />
        <div>Enable Latching</div>
        <input id="g_pvLatching" type="checkbox" checked />
        <div>Item Size</div>
        <input id="g_pvItemSize" type="number" value="320"/>
        <div>Show Address</div>
        <input id="g_pvShowAddr" type="checkbox" checked />
        <div>Show Priority</div>
        <input id="g_pvShowPrio" type="checkbox" checked />
        <div>Show Timestamp</div>
        <input id="g_pvShowTs" type="checkbox" checked />
        <div>Master Penalty Box Slots</div>
        <input id="g_masterSlots" type="number" min="1" max="100" value="10" />
      </div>
      <div class="section">
        <h2>Project Templates Source</h2>
        <div class="kv">
          <div>Source Mode</div>
          <select id="tplSourceMode"><option value="tool">Tool (local)</option><option value="http">HTTP (running project)</option></select>
          <div>Project Templates URL</div>
          <input id="tplProjectUrl" type="text" placeholder="http://your-mapview-server/api/templates"/>
          <div>Local Import (.tmpl)</div>
          <input id="tplProjectFiles" type="file" accept=".tmpl,text/plain" multiple />
          <div></div>
          <button id="btnFetchProjectTemplates">Fetch Project Templates</button>
        </div>
      </div>
      <div class="section">
        <button id="btnApplyPV" class="btn-primary">Apply to Project</button>
        <button id="btnResetPV">Reset to Defaults</button>
        <div class="muted small">Applies globals and (in real app) **generates** screens + <code>Penalty_Box.globalx</code> & **writes templates** into the Project.</div>
      </div>
      <div class="section">
        <h2>Validation & Status</h2>
        <div class="status-item"><div class="title">Project Validation</div><div class="muted small" id="statusProject">No favourites yet.</div></div>
        <div class="status-item"><div class="title">Selected Group</div><div class="muted small" id="statusGroup">None selected.</div></div>
      </div>
    </div>
  </div>

  <div class="footer">Set <strong>Alarm API Base</strong> to <code>http://&lt;gvo-server-ip&gt;:9099/alarmapi/v1</code>. Use <strong>Alarm Picker…</strong> to add devices/alarms from Orbit.</div>

  <!-- Alarm Picker (shared) -->
  <dialog id="dlgAlarmPicker">
    <header><strong>Alarm Picker</strong></header>
    <div class="content stack">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <input id="apSearchDevice" class="search" placeholder="Filter devices (supports paths like Favourites/...)"/>
        <div class="row small">
          <label>Alarm filter <input id="apNameFilter" type="text" placeholder="optional, e.g., CPU_*_TEMP"/></label>
          <button id="apReloadDevices">Reload Devices</button>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label class="small">Devices</label>
          <div class="listbox" id="apDeviceList"></div>
        </div>
        <div>
          <label class="small">Alarms in selected device</label>
          <div class="listbox" id="apAlarmList"></div>
        </div>
      </div>
    </div>
    <div class="actions"><button id="apCancel">Cancel</button><button id="apChoose" class="btn-primary">Add Selected</button></div>
  </dialog>

<script>
  const state = {
    apiBase: 'http://127.0.0.1:9099/alarmapi/v1',
    subscriptionId: null,
    licensed:false,
    mapView:'Stopped',
    groups:[],
    lastAction:null,
    projectVars:{ orientation:'Vertical', cellSpacing:8, latching:true, itemSize:320, showAddr:true, showPrio:true, showTs:true },
    master:{ id:'EM::Penalty Box', inError:50, errorPositions:10, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'} },
    templates:[], projectTemplates:[], lastPushedTemplates:{}
  };

  const $=sel=>document.querySelector(sel); const uid=()=>Math.random().toString(36).slice(2,9);
  function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
  function download(filename,text){ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click(); }
  function autoFavPath(groupName, pathParts){ return ['Favourites', groupName, ...pathParts.filter(Boolean)]; }
  function toast(msg){ alert(msg); }

  // API helpers
  async function apiGet(path){ const url = state.apiBase + path; const res = await fetch(url, { headers: { 'Accept':'application/json' } }); if(!res.ok) throw new Error('HTTP '+res.status+' '+url); return res.status===204? null : await res.json(); }

  // Config
  $('#cfgApiBase').addEventListener('input', e=> state.apiBase = e.target.value.trim());
  $('#btnPing').onclick = async()=>{ try{ await apiGet('/ping'); $('#subBadge').textContent='AlarmAPI OK'; $('#subBadge').className='badge ok'; }catch(e){ $('#subBadge').textContent='AlarmAPI Error'; $('#subBadge').className='badge err'; toast(e.message); } };

  // Groups
  function renderGroups(filter=''){
    const list=$('#groupList'); list.innerHTML=''; const q=(filter||'').toLowerCase();
    state.groups.filter(g=>!q||g.name.toLowerCase().includes(q)).forEach(g=>{
      const div=document.createElement('div'); div.className='list-item'+(g===state.sel?' active':'');
      const v=validateGroup(g); const badge=document.createElement('span'); badge.className='badge '+(v.ok?'ok':'warn'); badge.textContent=v.ok?'Complete':'Incomplete';
      const name=document.createElement('div'); name.textContent=g.name; name.style.flex='1';
      div.appendChild(badge); div.appendChild(name); div.onclick=()=>{ state.sel=g; openEditor(g); renderGroups($('#searchGroups').value); };
      list.appendChild(div);
    });
    $('#statusProject').textContent = state.groups.length ? `${state.groups.length} favourite(s). Master slots: ${state.master.errorPositions}` : 'No favourites yet.';
  }

  function openEditor(g){
    $('#editorEmpty').style.display='none'; $('#editor').style.display='';
    $('#groupName').value=g.name; $('#groupIdentifier').textContent=`EM::${g.name}`;
    const useGlobal=(g.useGlobalSettings!==false); $('#modeGlobal').checked=useGlobal; $('#modeLocal').checked=!useGlobal; setLocalControlsEnabled(!useGlobal);
    $('#inErrorState').value=String(g.inError??50); $('#errorPositions').value=g.errorPositions??2; $('#primarySort').value=g.sorts?.p??'Priority'; $('#secondarySort').value=g.sorts?.s??'State'; $('#tertiarySort').value=g.sorts?.t??'Date (Newest First)';
    const src = useGlobal ? state.projectVars : (g.localSettings || state.projectVars);
    $('#lvOrientation').value=src.orientation; $('#lvCellSpacing').value=src.cellSpacing; $('#lvLatching').checked=src.latching; $('#lvItemSize').value=src.itemSize; $('#lvShowAddr').checked=src.showAddr; $('#lvShowPrio').checked=src.showPrio; $('#lvShowTs').checked=src.showTs;
    renderGroupDevices(g); renderSubGroups(g); renderPreview(g); $('#statusGroup').textContent=validateGroup(g).msg;
  }

  function setLocalControlsEnabled(enabled){ ['lvOrientation','lvCellSpacing','lvLatching','lvItemSize','lvShowAddr','lvShowPrio','lvShowTs'].forEach(id=>{ const el=$('#'+id); if(el){ el.disabled=!enabled; el.closest('div').style.opacity = enabled? '1':'0.6'; }}); }

  function renderGroupDevices(g){ const tbody=$('#grpDevTable tbody'); tbody.innerHTML=''; (g.devices||[]).forEach((d,i)=>{ const alarmPath = autoFavPath(g.name, []).join('/'); const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(d.address)}</td><td>${escapeHtml(d.alarmName||'')}</td><td>${escapeHtml(alarmPath)}</td><td><span class='link' data-del='${i}'>Remove</span></td>`; tbody.appendChild(tr); });
    tbody.onclick=(e)=>{ if(e.target.matches('[data-del]')){ const i=+e.target.getAttribute('data-del'); g.devices.splice(i,1); renderGroupDevices(g); renderPreview(g); } } }
  $('#grpAddDev').onclick=()=>{ if(!state.sel) return toast('Select a favourite first'); const addr=$('#grpDevAddr').value.trim(); const aName=$('#grpAlarmName').value.trim(); if(!addr) return; if(!state.sel.devices) state.sel.devices=[]; state.sel.devices.push({address:addr, alarmName:aName||null}); $('#grpDevAddr').value=''; $('#grpAlarmName').value=''; renderGroupDevices(state.sel); renderPreview(state.sel); };

  // Alarm Picker integration
  let apCtx={ target:'group' };
  $('#grpPickAddr').onclick=()=>{ if(!state.sel) return toast('Select a favourite first'); apCtx={ target:'group' }; openAlarmPicker(); };

  // Sub-group minimal stubs (for Alarm Picker to add into editingCtx)
  let editingCtx=null; // not opening the full sub-group editor in this minimal file
  $('#apCancel').onclick=()=> dlg('#dlgAlarmPicker','close');

  function dlg(sel,cmd){ const d=$(sel); if(cmd==='open') d.showModal(); else d.close(); }

  async function openAlarmPicker(){ $('#apDeviceList').innerHTML=''; $('#apAlarmList').innerHTML=''; $('#apNameFilter').value=''; $('#apSearchDevice').value=''; dlg('#dlgAlarmPicker','open'); await loadDevices(); }
  async function loadDevices(){ try{ const devices = await apiGet('/devices'); state._devices = Array.isArray(devices)? devices : []; renderDeviceList(); }catch(e){ toast('Load devices failed: '+e.message); } }
  function renderDeviceList(){ const box=$('#apDeviceList'); box.innerHTML=''; const q=($('#apSearchDevice').value||'').toLowerCase(); (state._devices||[])
      .filter(d=> !q || String(d).toLowerCase().includes(q))
      .forEach(d=>{ const div=document.createElement('div'); div.className='itm'; const isFav = String(d).includes('Favourites/') || String(d).includes('System/');
        div.innerHTML = `${escapeHtml(d)} ${isFav? '<span class="state-pill state-ok">fav</span>':''}`;
        div.onclick=()=>{ box.querySelectorAll('.itm').forEach(n=> n.classList.remove('sel')); div.classList.add('sel'); loadDeviceAlarms(d); };
        box.appendChild(div);
      }); }
  $('#apSearchDevice').addEventListener('input', renderDeviceList);
  $('#apReloadDevices').onclick=loadDevices;

  async function loadDeviceAlarms(path){ const nameFilter = ($('#apNameFilter').value||'').trim(); try{ const enc='?path='+encodeURIComponent(path) + (nameFilter? '&name='+encodeURIComponent(nameFilter):''); const alarms = await apiGet('/alarms'+enc); state._alarms = Array.isArray(alarms)? alarms : []; renderAlarmList(); }catch(e){ toast('Load alarms failed: '+e.message); } }
  function renderAlarmList(){ const box=$('#apAlarmList'); box.innerHTML=''; (state._alarms||[]).forEach(a=>{ const nm = (a.id && a.id.name) || a.name || ''; const pth = (a.id && a.id.path) || a.path || '';
    const st = (a.state && a.state.state) || ''; const ts = (a.state && a.state.timestamp) || ''; const val = (a.state && a.state.value) || '';
    const cls = st==='fail' ? 'state-fail' : (st==='warn'||st==='caution') ? 'state-warn' : 'state-ok';
    const div=document.createElement('div'); div.className='itm';
    div.innerHTML = `<strong>${escapeHtml(nm)}</strong> <span class='muted small'>${escapeHtml(pth)}</span>
      <span class='state-pill ${cls}' title='${escapeHtml(st)}'>${escapeHtml(st||'ok')}</span>
      <div class='muted small'>${escapeHtml(val)} <span style='margin-left:6px'>${escapeHtml(ts)}</span></div>`;
    div.onclick=()=>{ div.classList.toggle('sel'); };
    box.appendChild(div);
  }); }

  $('#apChoose').onclick=()=>{ const selDevs = Array.from($('#apDeviceList').querySelectorAll('.itm.sel'));
    const chosenAlarms = Array.from($('#apAlarmList').querySelectorAll('.itm.sel'));
    if(!state.sel) return;
    if(chosenAlarms.length){ chosenAlarms.forEach(el=>{ const name=el.querySelector('strong').textContent; const path=(el.querySelector('.muted')?.textContent)||''; if(!state.sel.devices) state.sel.devices=[]; state.sel.devices.push({address:path, alarmName:name}); }); }
    else if(selDevs.length){ selDevs.forEach(el=>{ const path=el.textContent.replace(/\s*fav\s*$/,''); if(!state.sel.devices) state.sel.devices=[]; state.sel.devices.push({address:path}); }); }
    renderGroupDevices(state.sel); renderPreview(state.sel);
    dlg('#dlgAlarmPicker','close');
  };

  function renderSubGroups(g){ const tbody=$('#subGroupTable tbody'); tbody.innerHTML=''; (g.subGroups||[]).forEach((sg,idx)=>{ const childCount=(sg.subGroups||[]).length; const fav=autoFavPath(g.name, sg.__path||[sg.name]).join('/'); const devCount=(sg.devices||[]).length; const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(sg.name||'')}</td><td>${escapeHtml(fav)}</td><td>${escapeHtml(sg.template||'')}</td><td>${devCount}</td><td>${childCount}</td><td><span class='link' data-idx='${idx}'>Edit</span> · <span class='link' data-del='${idx}'>Delete</span></td>`; tbody.appendChild(tr); });
    tbody.onclick=(e)=>{ if(e.target.matches('[data-idx]')) alert('Sub-group editor available in full v10.3'); if(e.target.matches('[data-del]')){ const i=parseInt(e.target.getAttribute('data-del')); state.sel.subGroups.splice(i,1); renderSubGroups(state.sel); renderPreview(state.sel); } } }

  function renderPreview(g){ const lines=[]; lines.push(`Identifier: EM::${g.name}`); lines.push(`In Error State: ${g.inError}`); lines.push(`Error Positions (N): ${g.errorPositions}`); lines.push(`Sort: ${g.sorts.p} / ${g.sorts.s} / ${g.sorts.t}`); lines.push(`Settings: ${g.useGlobalSettings!==false ? 'Global' : 'Local'}`);
    let itemCount=(g.devices||[]).length; (function count(sgs){ (sgs||[]).forEach(s=>{ itemCount+=(s.devices||[]).length; count(s.subGroups); }); })(g.subGroups); lines.push(`Resolved Items: ${itemCount}`); $('#previewCode').textContent=lines.join('\n'); }

  function validateGroup(g){ if(!g.name) return {ok:false,msg:'Name required'}; if(state.groups.filter(x=>x!==g && x.name===g.name).length) return {ok:false,msg:'Name must be unique'}; let devices=(g.devices||[]).length; (function count(sgs){(sgs||[]).forEach(s=>{devices+=(s.devices||[]).length; count(s.subGroups);});})(g.subGroups); if(devices===0) return {ok:false,msg:'Add devices or alarms at group or sub-group level'}; return {ok:true,msg:'Complete'}; }

  // Create/Duplicate/Undo
  $('#btnCreate').onclick=()=>{ dlg('#dlgCreate','open'); };
  const createDlg = document.createElement('dialog'); createDlg.id='dlgCreate'; createDlg.innerHTML=`<header><strong>Create Favourite (Alarm Group)</strong></header>
    <div class='content stack'><div class='stack'><label>Name</label><input id='newGroupName' type='text' placeholder='e.g., Channel 4'/></div>
    <div class='muted small'>An Exception Monitor will be created with identifier <code>EM::{GroupName}</code>.</div></div>
    <div class='actions'><button id='createCancel'>Cancel</button><button id='createOk' class='btn-primary'>Create</button></div>`; document.body.appendChild(createDlg);
  document.body.addEventListener('click',(e)=>{
    if(e.target.id==='createCancel') dlg('#dlgCreate','close');
    if(e.target.id==='createOk'){
      const name=document.querySelector('#newGroupName').value.trim(); if(!name) return toast('Enter a name'); if(state.groups.find(g=>g.name===name)) return toast('Name must be unique'); const g={ id:uid(), name, inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, devices:[], subGroups:[], useGlobalSettings:true, localSettings:{ orientation:'Vertical', cellSpacing:8, latching:true, itemSize:320, showAddr:true, showPrio:true, showTs:true } }; state.groups.push(g); state.lastAction={type:'create',id:g.id}; renderGroups(); dlg('#dlgCreate','close'); state.sel=g; openEditor(g);
    }
  });

  $('#btnDuplicate').onclick=()=> toast('Duplicate available in full v10.3 file');
  $('#btnUndo').onclick=()=>{ const a=state.lastAction; if(!a) return; if(a.type==='create') state.groups = state.groups.filter(g=>g.id!==a.id); state.lastAction=null; state.sel=null; renderGroups(); $('#editor').style.display='none'; $('#editorEmpty').style.display=''; };

  $('#btnDeleteGroup').onclick=()=>{ if(!state.sel) return; if(!confirm('Delete favourite '+state.sel.name+'?')) return; state.groups = state.groups.filter(g=>g!==state.sel); state.sel=null; renderGroups(); $('#editor').style.display='none'; $('#editorEmpty').style.display=''; };
  $('#btnSaveGroup').onclick=()=>{ if(!state.sel) return; state.sel.name=$('#groupName').value.trim(); state.sel.inError=Number($('#inErrorState').value); state.sel.errorPositions=Number($('#errorPositions').value); state.sel.sorts={ p:$('#primarySort').value, s:$('#secondarySort').value, t:$('#tertiarySort').value }; renderGroups($('#searchGroups').value); openEditor(state.sel); };

  $('#groupName').addEventListener('input',()=>{ if(!state.sel) return; $('#groupIdentifier').textContent='EM::'+$('#groupName').value.trim(); });
  $('#searchGroups').addEventListener('input',(e)=> renderGroups(e.target.value));

  function syncPvPanelFromState(){ $('#g_pvOrientation').value=state.projectVars.orientation; $('#g_pvCellSpacing').value=state.projectVars.cellSpacing; $('#g_pvLatching').checked=state.projectVars.latching; $('#g_pvItemSize').value=state.projectVars.itemSize; $('#g_pvShowAddr').checked=state.projectVars.showAddr; $('#g_pvShowPrio').checked=state.projectVars.showPrio; $('#g_pvShowTs').checked=state.projectVars.showTs; $('#g_masterSlots').value=state.master.errorPositions; }
  syncPvPanelFromState(); renderGroups();

  // Sample data loader
  $('#btnLoadSample').onclick=()=>{ state.groups=[ { id:uid(), name:'Channel 1', devices:[{address:'F110:01:02', alarmName:null},{address:'Favourites/Playout Channels/Channel 1', alarmName:'NAME'}], inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, useGlobalSettings:true, localSettings:{orientation:'Vertical',cellSpacing:8,latching:true,itemSize:320,showAddr:true,showPrio:true,showTs:true}, subGroups:[ ]} ]; state.sel=state.groups[0]; renderGroups(); openEditor(state.sel); };
</script>
</body>
</html>
