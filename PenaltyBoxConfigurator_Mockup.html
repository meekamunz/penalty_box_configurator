<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Penalty Box Configurator – Interactive Mockup (v11.1.0 – Aggregated alarms, Connect modal, Templates... local+remote, nested sub-groups)</title>
<style>
  :root { --bg:#0f1115; --panel:#171a21; --panel-2:#1f2430; --text:#e6e9ef; --muted:#a5adcb; --accent:#7aa2f7; --ok:#73daca; --warn:#e0af68; --err:#f7768e; --badge:#2b3245; --btn:#2d3344; --btn-h:#3b435a; --link:#86aaec; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid #222635;background:#11141a;position:sticky;top:0;z-index:3}
  header h1{font-size:18px;margin:0;font-weight:600;letter-spacing:.3px}
  .toolbar{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
  button,.btn{background:var(--btn);color:var(--text);border:1px solid #2b3040;border-radius:6px;padding:8px 10px;cursor:pointer;font-size:13px}
  button:hover,.btn:hover{background:var(--btn-h)}
  .btn-primary{background:#26406b;border-color:#2f4d81}
  .btn-primary:hover{background:#315587}
  .btn-danger{background:#5a2330;border-color:#6b2a39}
  .btn-danger:hover{background:#6b2a39}
  .layout{display:grid;grid-template-columns:280px 1fr 380px;gap:12px;padding:12px}
  .panel{background:var(--panel);border:1px solid #22283a;border-radius:10px;padding:12px}
  .panel h2{font-size:14px;margin:0 0 8px 0;font-weight:600;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:6px;max-height:calc(100vh - 190px);overflow:auto;padding-right:4px}
  .list-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:var(--panel-2);border:1px solid #2b3245;cursor:pointer}
  .list-item:hover{border-color:#3a445f}
  .list-item.active{outline:2px solid var(--accent)}
  .badge{padding:2px 6px;border-radius:999px;font-size:11px;background:var(--badge);color:var(--muted)}
  .badge.ok{background:#0f1a12;color:#73daca;border:1px solid #1e3b2d}
  .badge.warn{background:#2a2512;color:#e0af68;border:1px solid #4a3f1e}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;color:var(--muted)}
  select,input[type="text"],input[type="number"],textarea{background:#0f1320;color:var(--text);border:1px solid #2b3245;border-radius:6px;padding:8px;font-size:13px}
  input[type="checkbox"]{transform:translateY(1px)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .section{border-top:1px dashed #2b3245;margin-top:10px;padding-top:10px}
  .muted{color:var(--muted);font-size:12px}
  .pill{padding:6px 8px;background:#0f1320;border:1px solid #2b3245;border-radius:6px;font-size:12px}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:6px;align-items:center}
  .status-item{background:var(--panel-2);border:1px solid #2b3245;border-radius:8px;padding:8px;margin-bottom:8px}
  .status-item .title{font-weight:600;font-size:13px}
  .footer{text-align:center;color:var(--muted);font-size:12px;padding:12px}
  .search{width:100%}
  .toolbar-inline{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .stack{display:flex;flex-direction:column;gap:8px}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{border-bottom:1px solid #2b3245;padding:6px 8px;text-align:left;vertical-align:top}
  .table th{color:var(--muted);font-weight:600}
  .link{color:var(--link);cursor:pointer;text-decoration:underline}
  dialog{border:1px solid #2b3245;background:var(--panel);color:var(--text);border-radius:10px;padding:0;width:1000px;max-width:96vw}
  dialog header{padding:12px 14px;border-bottom:1px solid #2b3245;background:var(--panel-2)}
  dialog .content{padding:12px}
  dialog .actions{padding:12px;border-top:1px solid #2b3245;display:flex;gap:8px;justify-content:flex-end}
  .small{font-size:12px}
  .code{background:#0b0f1a;border:1px solid #20283e;padding:8px;border-radius:8px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:#cbd5f7;white-space:pre-wrap}
  .listbox{height:240px; width:100%; background:#0f1320; border:1px solid #2b3245; border-radius:6px; padding:6px; overflow:auto;}
  .listbox .itm{padding:6px 8px; border-bottom:1px dashed #232a3d; cursor:pointer}
  .listbox .itm:hover{background:#151a2a}
  .listbox .itm.sel{background:#1b2336}
  .state-pill{display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; margin-left:6px; border:1px solid #2b3245}
  .state-ok{background:#0f1a12; color:#73daca; border-color:#1e3b2d}
  .state-warn{background:#2a2512; color:#e0af68; border-color:#4a3f1e}
  .state-fail{background:#2a1418; color:#f7768e; border-color:#5b2730}
</style>
</head>
<body>
  <header>
    <div class="row" style="justify-content:space-between;">
      <div class="row" style="gap:10px; align-items:center;">
        <h1>Penalty Box Configurator – <span class="muted">v11.1.0</span></h1>
        <label style="display:flex; flex-direction:column;">
          <span class="muted">GV Orbit Server IP</span>
          <div class="row" style="gap:6px;align-items:center;">
            <input id="cfgIp" type="hidden" value="127.0.0.1" />
            <span id="cfgIpDisplay" class="muted">127.0.0.1</span>
            <span id="connStatus" class="pill">Not connected</span>
            <button id="lnkConnect" class="btn">Connect…</button>
          </div>
        </label>
      </div>
      <div class="toolbar">
        <button id="btnCreate">New Favourite</button>
        <button id="btnDuplicate">Duplicate Favourite</button>
        <button id="btnUndo">Undo Duplication</button>
        <button id="btnTemplateBrowser">Templates...</button>
        <button id="btnGenerate" class="btn-primary">Generate Bundle</button>
        <button id="btnLoadSample">Load Sample</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <div class="panel">
      <div class="toolbar-inline">
        <h2>Favourites</h2>
        <input class="search" id="searchGroups" placeholder="Search favourites..." />
      </div>
      <div class="list" id="groupList"></div>
    </div>

    <div class="panel" id="editorPanel">
      <h2>Favourites Editor</h2>
      <div class="stack" id="editorEmpty">
        <div class="muted">Select a favourite (alarm group) to edit, or click <strong>New Favourite</strong>.</div>
      </div>
      <div class="stack" id="editor" style="display:none;">

        <!-- Editor header: Group name, identifier, error/sorting (added back for v11 JS compatibility) -->
        <div class="grid-3" style="margin-bottom:8px;">
          <div class="stack">
            <label>Group Name</label>
            <input id="groupName" type="text" />
          </div>
          <div class="stack">
            <label>MbyE Identifier</label>
            <div class="pill" id="groupIdentifier">EM::</div>
          </div>
          <div class="stack">
            <label>Template</label>
            <div class="row"><input id="grpTemplate" type="text" placeholder="example.tmpl"/><button id="grpPickTemplate">Pick…</button></div>
          </div>
          <div class="stack">
            <div class="grid-2">
              <div class="stack">
                <label>In Error State</label>
                <select id="inErrorState">
                  <option value="50">Minor / WARN (50)</option>
                  <option value="75">Major (75)</option>
                  <option value="100">Critical / FAIL (100)</option>
                </select>
              </div>
              <div class="stack">
                <label>Error Positions (top-N)</label>
                <input id="errorPositions" type="number" min="1" max="50" value="2" />
              </div>
            </div>
            <div style="margin-top:8px">
              <label>Sorting</label>
              <div class="row">
                <select id="primarySort"><option>Priority</option><option>State</option><option>Date (Newest First)</option><option>Address</option></select>
                <select id="secondarySort"><option>State</option><option>Priority</option><option>Date (Newest First)</option><option>Address</option></select>
                <select id="tertiarySort"><option>Date (Newest First)</option><option>Priority</option><option>State</option><option>Address</option></select>
              </div>
            </div>
          </div>
        </div>

        <!-- Group-level devices/alarms -->
        <div class="section">
          <div class="row" style="justify-content: space-between;align-items:center;">
            <h3 style="margin:0;font-size:13px;color:var(--muted)">Group-level Devices & Alarms</h3>
            <div class="row">
              <input id="grpDevAddr" type="text" placeholder="Device path (e.g., F110:01:01 or Favourites/...)"/>
              <input id="grpAlarmName" type="text" placeholder="Alarm name (optional)"/>
              <button id="grpAddDev">Add</button>
              <button id="grpPickAddr">Alarm Picker…</button>
            </div>
          </div>
          <table class="table" id="grpDevTable">
            <thead><tr><th>Device Path</th><th>Alarm</th><th>Alarm Path</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Sub-groups -->
        <div class="section">
          <div class="row" style="justify-content: space-between;">
            <h3 style="margin:0;font-size:13px;color:var(--muted)">Sub-groups</h3>
            <button id="btnAddSubGroup">Add Sub-group</button>
          </div>
          <table class="table" id="subGroupTable">
            <thead>
              <tr><th>Name</th><th>Alarm Path</th><th>Template</th><th>Devices/Alarms</th><th>Children</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Settings Mode + Local Settings -->
        <div class="section">
          <div class="stack" style="margin-bottom:8px;">
            <label>Settings Mode</label>
            <div class="row small">
              <label><input type="radio" name="settingsMode" id="modeGlobal" value="global"> Global Settings</label>
              <label><input type="radio" name="settingsMode" id="modeLocal" value="local"> Local Settings</label>
              <span class="muted small" id="modeTip">(Global is default)</span>
            </div>
          </div>

          <div class="grid-2">
            <div class="stack">
              <label>Local Settings (overrides Global when selected)</label>
              <div class="kv">
                <div>Layout Orientation</div>
                <select id="lvOrientation"><option>Vertical</option><option>Horizontal</option></select>
                <div>Cell Spacing</div>
                <input id="lvCellSpacing" type="number" min="0" max="64" value="8" />
                <div>Enable Latching</div>
                <input id="lvLatching" type="checkbox" checked />
                <div>Item Size</div>
                <input id="lvItemSize" type="number" value="320"/>
                <div>Show Address</div>
                <div class="row"><input id="lvShowAddr" type="checkbox" checked/><label for="lvShowAddr">Show Address</label></div>
                <div>Show Priority</div>
                <div class="row"><input id="lvShowPrio" type="checkbox" checked/><label for="lvShowPrio">Show Priority</label></div>
                <div>Show Timestamp</div>
                <div class="row"><input id="lvShowTs" type="checkbox" checked/><label for="lvShowTs">Show Timestamp</label></div>
              </div>
            </div>
            <div class="stack">
              <label>Identifier & Preview</label>
              <div class="code" id="previewCode">// Behaviour preview will appear here</div>
            </div>
          </div>
        </div>

        <div class="section">
          <button class="btn-primary" id="btnSaveGroup">Save Favourite</button>
          <button class="btn-danger" id="btnDeleteGroup">Delete Favourite</button>
        </div>
      </div>
    </div>

    <div class="panel right-form">
      <h2>Global Settings</h2>
      <div class="kv">
        <div>Layout Orientation</div>
        <select id="g_pvOrientation"><option>Vertical</option><option>Horizontal</option></select>
        <div>Cell Spacing</div>
        <input id="g_pvCellSpacing" type="number" min="0" max="64" value="8" />
        <div>Enable Latching</div>
        <input id="g_pvLatching" type="checkbox" checked />
        <div>Item Size</div>
        <input id="g_pvItemSize" type="number" value="320"/>
        <div>Show Address</div>
        <input id="g_pvShowAddr" type="checkbox" checked />
        <div>Show Priority</div>
        <input id="g_pvShowPrio" type="checkbox" checked />
        <div>Show Timestamp</div>
        <input id="g_pvShowTs" type="checkbox" checked />
        <div>Master Penalty Box Slots</div>
        <input id="g_masterSlots" type="number" min="1" max="100" value="10" />
      </div>
      <div class="section">
        <h2>Validation & Status</h2>
        <div class="status-item"><div class="title">Project Validation</div><div class="muted small" id="statusProject">No favourites yet.</div></div>
        <div class="status-item"><div class="title">Selected Favourite</div><div class="muted small" id="statusGroup">None selected.</div></div>
      </div>
    </div>
  </div>

  <div class="footer">v11.1.0: Connect modal, aggregated alarms with dual filters, local+remote templates in Templates..., nested sub-groups, defaults to Global, labels refined, picker/browser dynamic updates and template preview improvements.</div>

  <!-- Connect modal -->
  <dialog id="dlgConnect">
    <header><strong>Connect to GV Orbit Server</strong></header>
    <div class="content stack">
      <div class="row" style="gap:10px; align-items:flex-end;">
        <label style="flex:1">Server IP<input id="connIp" type="text" placeholder="e.g., 192.168.1.153"/></label>
        <button id="btnDoConnect" class="btn-primary">Test & Connect</button>
      </div>
      <div class="muted small">This tests <code>GET /devices</code> on <code>http://&lt;IP&gt;:9099/alarmapi/v1</code>.</div>
      <div id="connMsg" class="muted small"></div>
    </div>
    <div class="actions"><button id="connClose">Close</button></div>
  </dialog>

  <!-- Create Template dialog -->
  <dialog id="dlgCreateTemplate">
    <header><strong>Create Local Template (from devices/alarms)</strong></header>
    <div class="content stack">
      <label>Name<input id="ctName" type="text" placeholder="MyTemplate.tmpl"/></label>
      <div class="row" style="justify-content:space-between;align-items:center;">
        <div class="muted small">Pick multiple devices/alarms to convert into headers.</div>
        <button id="ctPick">Alarm Picker…</button>
      </div>
      <table class="table" id="ctHeaderTable"><thead><tr><th>Header</th><th>Source Path</th><th></th></tr></thead><tbody></tbody></table>
      <div class="row small">
        <input id="ctManualHeader" type="text" placeholder="Add manual header (e.g., HEALTH)"/>
        <button id="ctAddManual">Add Header</button>
      </div>
      <div class="muted small">Headers derive from alarm names (preferred) or last device path segment.</div>
    </div>
    <div class="actions"><button id="ctCancel">Cancel</button><button id="ctOk" class="btn-primary">Save Template</button></div>
  </dialog>

  <!-- Duplicate dialog -->
  <dialog id="dlgDuplicate">
    <header><strong>Duplicate Favourite(s)</strong></header>
    <div class="content stack">
      <div class="grid-3">
        <div class="stack"><label>Base Name</label><input id="dupBaseName" type="text" placeholder="Channel %d"/></div>
        <div class="stack"><label>Count (1-999)</label><input id="dupCount" type="number" min="1" max="999" value="3"/></div>
        <div class="stack"><label>Structure Only</label><input id="dupStructureOnly" type="checkbox"/></div>
      </div>
      <div class="muted small">Supports %d / %x and zero‑padded %0Nd (e.g., %02d).</div>
    </div>
    <div class="actions"><button id="dupCancel">Cancel</button><button id="dupOk" class="btn-primary">Duplicate</button></div>
  </dialog>

  <!-- Sub-group editor -->
  <dialog id="dlgSubGroup">
    <header><strong>Edit Sub-group</strong></header>
    <div class="content stack">
      <div class="grid-2">
        <div class="stack"><label>Name</label><input id="sgName" type="text"/></div>
        <div class="stack"><label>Alarm Path (auto)</label><input id="sgFav" type="text" readonly/></div>
      </div>
      <div class="grid-2">
        <div class="stack"><label>Template</label><div class="row"><input id="sgTemplate" type="text" placeholder="example.tmpl"/><button id="sgPickTemplate">Pick…</button></div></div>
        <div class="stack"><label>Add Address</label><div class="row"><input id="sgDevAddr" type="text" placeholder="Device path"/><input id="sgAlarmName" type="text" placeholder="Alarm name (optional)"/><button id="sgPickAddr">Alarm Picker…</button><button id="sgAddDev">Add</button></div></div>
      </div>
      <table class="table" id="sgDevTable"><thead><tr><th>Device Path</th><th>Alarm</th><th></th></tr></thead><tbody></tbody></table>
      <div style="margin-top:10px">
        <h4 class="muted small">Child Sub-groups</h4>
        <table class="table" id="sgChildTable"><thead><tr><th>Name</th><th>Alarm Path</th><th>Template</th><th>Devices</th><th>Children</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class="actions">
      <button id="sgAddChild">Add Child Sub-group</button>
      <span style="flex:1"></span>
      <button id="sgCancel">Cancel</button><button id="sgOk" class="btn-primary">Save</button>
    </div>
  </dialog>

  <!-- Template Picker (sub-group) -->
  <dialog id="dlgPickTemplate">
    <header><strong>Pick Template</strong></header>
    <div class="content stack">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <input id="tplPickSearch" class="search" placeholder="Search templates..."/>
        <div class="row small">
          <label><input type="checkbox" id="tplIncludeProject"/> Include Remote (Project)</label>
          <label><input type="checkbox" id="tplIncludeLocal" checked/> Include Local</label>
        </div>
      </div>
      <div class="listbox" id="tplPickList"></div>
      <div class="code" id="tplPickView">No template selected. Select a template to view its headers.</div>
    </div>
    <div class="actions"><button id="tplPickCancel">Cancel</button><button id="tplPickOpenBrowser">Open Templates...</button><button id="tplPickChoose" class="btn-primary">Choose</button></div>
  </dialog>

  <!-- Alarm Picker (shared) -->
  <dialog id="dlgAlarmPicker">
    <header><strong>Alarm Picker</strong></header>
    <div class="content stack">
      <div class="grid-2">
        <div>
          <label class="small">Device filter</label>
          <input id="apFilterDevice" class="search" placeholder="Filter devices (supports paths like Favourites/...)"/>
          <div class="listbox" id="apDeviceList"></div>
        </div>
        <div>
          <label class="small">Alarm filter</label>
          <input id="apFilterAlarm" class="search" placeholder="Filter alarms (by name)"/>
          <div class="listbox" id="apAlarmList"></div>
        </div>
      </div>
      <div class="row small" style="justify-content:flex-end; gap:8px;">
        <button id="apReloadDevices">Reload Devices</button>
      </div>
    </div>
    <div class="actions"><button id="apCancel">Cancel</button><button id="apChoose" class="btn-primary">Add Selected</button></div>
  </dialog>

  <!-- Templates... (global, HTTP only) -->
  <dialog id="dlgTemplateBrowser">
    <header><strong>Templates...</strong></header>
    <div class="content stack">
      <div class="row" style="gap:8px;align-items:flex-end;">
        <div style="flex:1"></div>
        <div class="pill" id="tbAutoIp">Using GV IP</div>
      </div>
      <div class="row small">
        <label><input type="checkbox" id="tbIncludeRemote" checked/> Include Remote (HTTP bridge)</label>
        <label><input type="checkbox" id="tbIncludeLocal" checked/> Include Local Templates</label>
      </div>
      <div class="row" style="gap:8px;align-items:flex-end;">
        <label>User (optional)<input id="tbUser" type="text" placeholder="root"/></label>
        <label>Password (optional)<input id="tbPass" type="password" placeholder="••••"/></label>
        <button id="tbLoadRepos">Refresh Remote</button>
        <button id="tbCreateTemplate">Create Template</button>
      </div>
      <div class="grid-2">
        <div>
          <label class="small">Repos (Remote)</label>
          <div class="listbox" id="tbRepoList"></div>
        </div>
        <div>
          <label class="small">Templates</label>
          <div class="listbox" id="tbTplList"></div>
        </div>
      </div>
      <div class="code" id="tbView">No template selected. Toggle Local/Remote to view all available templates. Browser fetch requires HTTP(S) and CORS; SSH (port 2222) cannot be used directly.</div>
    </div>
    <div class="actions"><button id="tbClose">Close</button></div>
  </dialog>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const bind = (sel, event, handler) => { const el=$(sel); if(!el){ console.warn('Missing element', sel); return; } el.addEventListener(event, handler); };
    const dlg = (sel, cmd) => { const d=$(sel); if(!d){ console.warn('Missing dialog', sel); return; } if(cmd==='open') d.showModal(); else d.close(); };

    const state = {
      apiBase: 'http://127.0.0.1:9099/alarmapi/v1',
      connected:false,
      groups:[], sel:null, lastAction:null,
      projectVars:{ orientation:'Vertical', cellSpacing:8, latching:true, itemSize:320, showAddr:true, showPrio:true, showTs:true },
      master:{ id:'EM::Penalty Box', inError:50, errorPositions:10, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'} },
      templates:[{ name:'example.tmpl', headers:['MSG','STATUS','STATE','UPTIME'] }],
      projectTemplates:[], editingCtx:null,
      _devices:[], selectedDevices:[], agg:{byName:new Map(), flat:[]},
      tplApi:{ base:'', user:'', pass:'' }, ctHeaders:[],
    };

    const uid=()=>Math.random().toString(36).slice(2,9);
    const escapeHtml=(str)=> (str||'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    const autoFavPath=(groupName, parts)=> ['Favourites', groupName, ...parts.filter(Boolean)];
    const toast=(msg)=> alert(msg);
    const download=(filename,text)=>{ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(text); a.download=filename; a.click(); };

    function recomputeApiBase(){ const ip=($('#cfgIp').value||'').trim()||'127.0.0.1'; state.apiBase = `http://${ip}:9099/alarmapi/v1`; const tbBase = `http://${ip}:8080`; const pill=$('#tbAutoIp'); if(pill){ pill.textContent = `Using GV IP: ${tbBase}`; pill.title='Templates... defaults to this base URL'; }
      const disp = $('#cfgIpDisplay'); if(disp) disp.textContent = ip;
    }
    recomputeApiBase();

    function setConnStatus(connected, text){ state.connected = !!connected; const el = $('#connStatus'); if(!el) return; el.textContent = text || (connected? 'Connected' : 'Not connected'); if(connected){ el.style.background = '#0f1a12'; el.style.borderColor = '#1e3b2d'; el.style.color = '#73daca'; } else { el.style.background = '#2a1418'; el.style.borderColor = '#5b2730'; el.style.color = '#f7768e'; } }

    async function apiGet(path){ const url = state.apiBase + path; const res = await fetch(url, { headers: { 'Accept':'application/json' } }); if(!res.ok) throw new Error('HTTP '+res.status+' '+url); return res.status===204? null : await res.json(); }

    // Connect modal UX
    function openConnectDialog(){ $('#connIp').value = ($('#cfgIp').value||'').trim(); $('#connMsg').textContent=''; dlg('#dlgConnect','open'); }
    bind('#lnkConnect','click',(e)=>{ e.preventDefault(); openConnectDialog(); });
    bind('#connClose','click',()=> dlg('#dlgConnect','close'));
    bind('#btnDoConnect','click', async()=>{
      const ip=$('#connIp').value.trim(); if(!ip){ toast('Enter IP'); return; }
      $('#cfgIp').value = ip; recomputeApiBase();
      try{
        const devs = await apiGet('/devices');
        const ok = Array.isArray(devs);
        if(ok){
          setConnStatus(true,'Connected');
          state._devices = devs||[];
          $('#connMsg').textContent='Connected successfully.';
          setTimeout(()=> dlg('#dlgConnect','close'), 400);
        } else {
          setConnStatus(false,'No devices');
          $('#connMsg').textContent='Connection failed (no devices returned).';
        }
      }catch(e){
        setConnStatus(false,'Connect failed');
        $('#connMsg').textContent='Connect failed: '+e.message;
      }
    });
    // Auto prompt on first load
    setTimeout(()=> openConnectDialog(), 350);

    function renderGroups(filter=''){
      const list=$('#groupList'); list.innerHTML=''; const q=(filter||'').toLowerCase();
      state.groups.filter(g=>!q||g.name.toLowerCase().includes(q)).forEach(g=>{
        const div=document.createElement('div'); div.className='list-item'+(g===state.sel?' active':'');
        const v=validateGroup(g); const badge=document.createElement('span'); badge.className='badge '+(v.ok?'ok':'warn'); badge.textContent=v.ok?'Complete':'Incomplete';
        const name=document.createElement('div'); name.textContent=g.name; name.style.flex='1';
        div.appendChild(badge); div.appendChild(name);
        div.addEventListener('click',()=>{ state.sel=g; openEditor(g); // re-render to update active highlight
          $$('#groupList .list-item').forEach(n=> n.classList.remove('active')); div.classList.add('active'); });
        list.appendChild(div);
      });
      const sp=$('#statusProject'); if(sp) sp.textContent = state.groups.length ? `${state.groups.length} favourite(s). Master slots: ${state.master.errorPositions}` : 'No favourites yet.';
    }

    function openEditor(g){ $('#editorEmpty').style.display='none'; $('#editor').style.display='';
      $('#groupName').value=g.name; $('#groupIdentifier').textContent=`EM::${g.name}`;
      $('#grpTemplate').value = g.template || '';
      const useGlobal=(g.useGlobalSettings!==false); $('#modeGlobal').checked=useGlobal; $('#modeLocal').checked=!useGlobal; setLocalControlsEnabled(!useGlobal);
      $('#modeTip').textContent = useGlobal? '(Global is default)' : '(Local overrides Global)';
      $('#inErrorState').value=String(g.inError??50); $('#errorPositions').value=g.errorPositions??2; $('#primarySort').value=g.sorts?.p??'Priority'; $('#secondarySort').value=g.sorts?.s??'State'; $('#tertiarySort').value=g.sorts?.t??'Date (Newest First)';
      const src = useGlobal ? state.projectVars : (g.localSettings || state.projectVars);
      $('#lvOrientation').value=src.orientation; $('#lvCellSpacing').value=src.cellSpacing; $('#lvLatching').checked=src.latching; $('#lvItemSize').value=src.itemSize; $('#lvShowAddr').checked=src.showAddr; $('#lvShowPrio').checked=src.showPrio; $('#lvShowTs').checked=src.showTs;
      renderGroupDevices(g); renderSubGroups(g); renderPreview(g); const sg=$('#statusGroup'); if(sg) sg.textContent=validateGroup(g).msg;
    }

    function setLocalControlsEnabled(enabled){ ['lvOrientation','lvCellSpacing','lvLatching','lvItemSize','lvShowAddr','lvShowPrio','lvShowTs'].forEach(id=>{ const el=$('#'+id); if(el){ el.disabled=!enabled; const box=el.closest('div'); if(box) box.style.opacity = enabled? '1':'0.6'; }}); }

    function renderGroupDevices(g){ const tbody=$('#grpDevTable tbody'); tbody.innerHTML=''; (g.devices||[]).forEach((d,i)=>{ const alarmPath = autoFavPath(g.name, []).join('/'); const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(d.address)}</td><td>${escapeHtml(d.alarmName||'')}</td><td>${escapeHtml(alarmPath)}</td><td><span class='link' data-del='${i}'>Remove</span></td>`; tbody.appendChild(tr); });
      tbody.onclick=(e)=>{ if(e.target.matches('[data-del]')){ const i=+e.target.getAttribute('data-del'); g.devices.splice(i,1); renderGroupDevices(g); renderPreview(g); } } }

    function renderSubGroups(g){ const tbody=$('#subGroupTable tbody'); tbody.innerHTML=''; (g.subGroups||[]).forEach((sg,idx)=>{ const childCount=(sg.subGroups||[]).length; const fav=autoFavPath(g.name, sg.__path||[sg.name]).join('/'); const devCount=(sg.devices||[]).length; const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(sg.name||'')}</td><td>${escapeHtml(fav)}</td><td>${escapeHtml(sg.template||'')}</td><td>${devCount}</td><td>${childCount}</td>
        <td><span class='link' data-idx='${idx}'>Edit</span> · <span class='link' data-del='${idx}'>Delete</span></td>`; tbody.appendChild(tr); });
      tbody.onclick=(e)=>{
        if(e.target.matches('[data-idx]')) editSubGroup(parseInt(e.target.getAttribute('data-idx')));
        if(e.target.matches('[data-del]')){ const i=parseInt(e.target.getAttribute('data-del')); state.sel.subGroups.splice(i,1); renderSubGroups(state.sel); renderPreview(state.sel); }
      }
    }

    function editSubGroup(idx){ state.editingCtx={ parentArray: state.sel.subGroups, index: idx, node: JSON.parse(JSON.stringify(state.sel.subGroups[idx])) }; if(!state.editingCtx.node.__path) state.editingCtx.node.__path=[state.editingCtx.node.name]; openSubGroupDialog(); }
    function openSubGroupDialog(){ const d=state.editingCtx.node; $('#sgName').value=d.name||''; $('#sgTemplate').value=d.template||''; updateFavPathField(); renderSgDevs(); renderChildSubGroups(); dlg('#dlgSubGroup','open'); }
    function renderChildSubGroups(){ const tbody=$('#sgChildTable tbody'); tbody.innerHTML=''; const edt = state.editingCtx; if(!edt) return; // prefer live children when available
      const liveParent = (edt.parentArray && typeof edt.index==='number' && edt.index>=0) ? (edt.parentArray[edt.index] || {}) : null;
      const children = (liveParent && Array.isArray(liveParent.subGroups)) ? liveParent.subGroups : (edt.node.subGroups||[]);
      children.forEach((sg,idx)=>{ const childCount=(sg.subGroups||[]).length; const fav=autoFavPath(state.sel.name, sg.__path||[sg.name]).join('/'); const devCount=(sg.devices||[]).length; const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(sg.name||'')}</td><td>${escapeHtml(fav)}</td><td>${escapeHtml(sg.template||'')}</td><td>${devCount}</td><td>${childCount}</td>
        <td><span class='link' data-idx='${idx}'>Edit</span> · <span class='link' data-del='${idx}'>Delete</span></td>`; tbody.appendChild(tr); });
      tbody.onclick=(e)=>{
        if(e.target.matches('[data-idx]')){
          const i=parseInt(e.target.getAttribute('data-idx'));
          // locate live parent array for this level
          const parentArrayLive = (edt.parentArray && typeof edt.index==='number' && edt.index>=0) ? (edt.parentArray[edt.index].subGroups = edt.parentArray[edt.index].subGroups || []) : (state.sel.subGroups = state.sel.subGroups || []);
          // set editingCtx to operate on the live array for the child
          state.editingCtx = { parentArray: parentArrayLive, index: i, node: JSON.parse(JSON.stringify(parentArrayLive[i])) };
          if(!state.editingCtx.node.__path) state.editingCtx.node.__path = (parentArrayLive[i] && parentArrayLive[i].__path) ? parentArrayLive[i].__path.slice() : [state.editingCtx.node.name];
          openSubGroupDialog();
        }
        if(e.target.matches('[data-del]')){
          const i=parseInt(e.target.getAttribute('data-del'));
          // delete from live array when possible
          const parentArrayLive = (edt.parentArray && typeof edt.index==='number' && edt.index>=0) ? (edt.parentArray[edt.index].subGroups = edt.parentArray[edt.index].subGroups || []) : (edt.node.subGroups = edt.node.subGroups || []);
          parentArrayLive.splice(i,1);
          // also sync editor copy
          edt.node.subGroups = (edt.node.subGroups||[]).slice(); edt.node.subGroups.splice(i,1);
          renderChildSubGroups();
        }
      }
    }
    function updateFavPathField(){ if(!state.editingCtx) return; const d=state.editingCtx.node; const inputName = ($('#sgName') && $('#sgName').value) ? $('#sgName').value.trim() : ''; const originalParts = (d.__path && d.__path.length) ? d.__path.slice() : [d.name]; const parts = originalParts.filter(Boolean); if(inputName) parts[parts.length-1] = inputName; $('#sgFav').value = autoFavPath(state.sel?.name||'', parts).join('/'); }
    function renderSgDevs(){ const tbody=$('#sgDevTable tbody'); tbody.innerHTML=''; (state.editingCtx.node.devices||[]).forEach((dv,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(dv.address)}</td><td>${escapeHtml(dv.alarmName||'')}</td><td><span class='link' data-del='${i}'>Remove</span></td>`; tbody.appendChild(tr); }); tbody.onclick=(e)=>{ if(e.target.matches('[data-del]')){ const i=+e.target.getAttribute('data-del'); state.editingCtx.node.devices.splice(i,1); renderSgDevs(); } } }
    bind('#sgAddDev','click',()=>{ const addr=$('#sgDevAddr').value.trim(); const aName=$('#sgAlarmName').value.trim(); if(!addr) return; state.editingCtx.node.devices.push({address:addr, alarmName:aName||null}); $('#sgDevAddr').value=''; $('#sgAlarmName').value=''; renderSgDevs(); });
    bind('#sgPickAddr','click',()=>{ if(!state.connected) return toast('Please connect to the GV Orbit Server first'); apCtx={ target:'subgroup' }; openAlarmPicker(); });
    bind('#sgAddChild','click',()=>{
      const edt = state.editingCtx; if(!edt) return; const name = prompt('Child sub-group name'); if(!name) return; const childName = name.trim(); const child = { name:childName, template:'', devices:[], subGroups:[], __path:[...(edt.node.__path||[edt.node.name]), childName] };
      // push into live data structure
      try{
        const liveParent = (edt.parentArray && typeof edt.index==='number' && edt.index>=0) ? edt.parentArray[edt.index] : null;
        if(liveParent){
          liveParent.subGroups = liveParent.subGroups || [];
          // persist into the live data structure
          liveParent.subGroups.push(JSON.parse(JSON.stringify(child)));
          // if the editor node is a separate copy, sync it; if it's the same object, avoid double-push
          if(liveParent !== edt.node){
            edt.node.subGroups = edt.node.subGroups || [];
            edt.node.subGroups.push(JSON.parse(JSON.stringify(child)));
          } else {
            // ensure editor view references the live array
            edt.node.subGroups = liveParent.subGroups;
          }
        } else {
          // fallback: modify editor-only node
          edt.node.subGroups = edt.node.subGroups || [];
          edt.node.subGroups.push(child);
        }
      }catch(e){ edt.node.subGroups = edt.node.subGroups || []; edt.node.subGroups.push(child); }
      renderChildSubGroups(); toast('Child sub-group added');
    });
    bind('#sgCancel','click',()=>{ dlg('#dlgSubGroup','close'); state.editingCtx=null; });
    bind('#sgOk','click',()=>{ const d=state.editingCtx.node; d.name=$('#sgName').value.trim(); d.template=$('#sgTemplate').value.trim(); if(d.__path && d.__path.length>0){ d.__path[d.__path.length-1] = d.name; } else { d.__path=[d.name]; } if(state.editingCtx.index>=0) state.editingCtx.parentArray[state.editingCtx.index]=d; else state.editingCtx.parentArray.push(d); dlg('#dlgSubGroup','close'); renderSubGroups(state.sel); renderPreview(state.sel); state.editingCtx=null; });

    // Group-level: add device and open Alarm Picker
    bind('#grpAddDev','click',()=>{ const addr=$('#grpDevAddr').value.trim(); const aName=$('#grpAlarmName').value.trim(); if(!addr) return; if(!state.sel) return toast('Select a favourite first'); state.sel.devices = state.sel.devices || []; state.sel.devices.push({ address: addr, alarmName: aName||null }); $('#grpDevAddr').value=''; $('#grpAlarmName').value=''; renderGroupDevices(state.sel); renderPreview(state.sel); });
    bind('#grpPickAddr','click',()=>{ if(!state.connected) return toast('Please connect to the GV Orbit Server first'); apCtx={ target:'group' }; openAlarmPicker(); });

    // Top-level Add Sub-group button (ask for a name, create and open editor)
    bind('#btnAddSubGroup','click',()=>{
      if(!state.sel) return toast('Select a favourite first');
      const name = prompt('Sub-group name');
      if(!name) return;
      state.sel.subGroups = state.sel.subGroups || [];
      const sg = { name: name.trim(), template:'', devices:[], subGroups:[], __path:[name.trim()] };
      state.sel.subGroups.push(sg);
      renderSubGroups(state.sel);
      // open editor for the newly created sub-group
      state.editingCtx = { parentArray: state.sel.subGroups, index: state.sel.subGroups.length-1, node: sg };
      openSubGroupDialog();
    });

    // Update alarm path live when editing sub-group name
    bind('#sgName','input', ()=> updateFavPathField());

    function renderPreview(g){ const pre=$('#previewCode'); if(!pre) return; const lines=[]; lines.push(`Identifier: EM::${g.name}`); lines.push(`In Error State: ${g.inError}`); lines.push(`Error Positions (N): ${g.errorPositions}`); lines.push(`Sort: ${g.sorts.p} / ${g.sorts.s} / ${g.sorts.t}`); lines.push(`Settings: ${g.useGlobalSettings!==false ? 'Global' : 'Local'}`); let itemCount=(g.devices||[]).length; (function count(sgs){ (sgs||[]).forEach(s=>{ itemCount+=(s.devices||[]).length; count(s.subGroups); }); })(g.subGroups); lines.push(`Resolved Items: ${itemCount}`); pre.textContent=lines.join('\n'); }

    function validateGroup(g){ if(!g.name) return {ok:false,msg:'Name required'}; if(state.groups.filter(x=>x!==g && x.name===g.name).length) return {ok:false,msg:'Name must be unique'}; let devices=(g.devices||[]).length; (function count(sgs){(sgs||[]).forEach(s=>{devices+=(s.devices||[]).length; count(s.subGroups);});})(g.subGroups); if(devices===0) return {ok:false,msg:'Add devices or alarms at group or sub-group level'}; return {ok:true,msg:'Complete'}; }

    // Alarm Picker with dual filters & aggregation
    bind('#apCancel','click',()=> dlg('#dlgAlarmPicker','close'));
    async function openAlarmPicker(){ $('#apDeviceList').innerHTML=''; $('#apAlarmList').innerHTML=''; $('#apFilterAlarm').value=''; $('#apFilterDevice').value=''; state.selectedDevices=[]; state.agg={byName:new Map(),flat:[]}; dlg('#dlgAlarmPicker','open'); if(state._devices.length===0){ try{ const devices = await apiGet('/devices'); state._devices = Array.isArray(devices)? devices : []; }catch(e){ toast('Load devices failed: '+e.message); } } renderDeviceList(); renderAlarmList(); }
    function renderDeviceList(){ const box=$('#apDeviceList'); box.innerHTML=''; const q=($('#apFilterDevice').value||'').toLowerCase(); (state._devices||[])
        .filter(d=> !q || String(d).toLowerCase().includes(q))
        .forEach(d=>{ const div=document.createElement('div'); div.className='itm'; const isFav = String(d).includes('Favourites/') || String(d).includes('System/');
          div.innerHTML = `${escapeHtml(d)} ${isFav? '<span class="state-pill state-ok">fav</span>':''}`;
          div.onclick=()=>{ div.classList.toggle('sel'); const path=String(d); if(div.classList.contains('sel')){ if(!state.selectedDevices.includes(path)) state.selectedDevices.push(path); } else { state.selectedDevices = state.selectedDevices.filter(p=>p!==path); }
            aggregateAlarmsForSelectedDevices(); };
          box.appendChild(div);
        }); }
    bind('#apFilterDevice','input', renderDeviceList);
    bind('#apReloadDevices','click', async()=>{ try{ const devices = await apiGet('/devices'); state._devices = Array.isArray(devices)? devices : []; renderDeviceList(); }catch(e){ toast('Reload devices failed: '+e.message); } });

    async function aggregateAlarmsForSelectedDevices(){ const qAlarm=($('#apFilterAlarm').value||'').toLowerCase(); state.agg={byName:new Map(), flat:[]};
      const promises = state.selectedDevices.map(async path=>{ try{ const enc='?path='+encodeURIComponent(path); const alarms = await apiGet('/alarms'+enc); (Array.isArray(alarms)? alarms:[]).forEach(a=>{
          const nm = ((a.id && a.id.name) || a.name || '').trim(); if(!nm) return; const pth = (a.id && a.id.path) || a.path || path; const bucket = state.agg.byName.get(nm) || []; bucket.push({ name:nm, path:pth, device:path, raw:a }); state.agg.byName.set(nm, bucket);
        }); }catch(e){ /* per-device error ignored */ }
      });
      await Promise.all(promises);
      state.agg.flat = Array.from(state.agg.byName.keys())
        .filter(nm=> !qAlarm || nm.toLowerCase().includes(qAlarm))
        .sort()
        .map(nm=>{ const arr = state.agg.byName.get(nm)||[]; const rep = arr[0]; return { name:nm, path:rep.path, count:arr.length }; });
      renderAlarmList();
    }
    bind('#apFilterAlarm','input', aggregateAlarmsForSelectedDevices);

    function renderAlarmList(){ const box=$('#apAlarmList'); box.innerHTML=''; (state.agg.flat||[]).forEach(item=>{ const cls='state-ok'; const div=document.createElement('div'); div.className='itm';
      div.dataset.name=item.name; div.dataset.count=item.count; div.innerHTML = `<strong>${escapeHtml(item.name)}</strong> <span class='muted small'>${escapeHtml(item.path)}</span>
        <span class='state-pill ${cls}' title='aggregated from ${item.count} device(s)'>${item.count} dev</span>`;
      div.onclick=()=>{ div.classList.toggle('sel'); };
      box.appendChild(div);
    }); }

    bind('#apChoose','click',()=>{
      const selDevs = $$('#apDeviceList .itm.sel');
      const chosenAlarms = $$('#apAlarmList .itm.sel');
      if(apCtx?.target==='template'){
        if(chosenAlarms.length){ chosenAlarms.forEach(el=>{ const name=el.dataset.name||el.querySelector('strong').textContent||''; addCtHeader(name, (state.agg.byName.get(name)?.[0]?.path)||''); }); }
        else if(selDevs.length){ selDevs.forEach(el=>{ const path=el.textContent.replace(/\s*fav\s*$/,''); const seg = (String(path).split('/').pop()||path); addCtHeader(seg, path); }); }
        renderCtHeaders(); dlg('#dlgAlarmPicker','close'); return;
      }
      if(!state.sel) { dlg('#dlgAlarmPicker','close'); return; }
      if(apCtx?.target==='group'){
        if(chosenAlarms.length){ chosenAlarms.forEach(el=>{ const name=el.dataset.name||el.querySelector('strong').textContent; const bucket = state.agg.byName.get(name)||[]; bucket.forEach(rec=>{ if(!state.sel.devices) state.sel.devices=[]; state.sel.devices.push({address:rec.path, alarmName:name}); }); }); }
        else if(selDevs.length){ selDevs.forEach(el=>{ const path=el.textContent.replace(/\s*fav\s*$/,''); if(!state.sel.devices) state.sel.devices=[]; state.sel.devices.push({address:path}); }); }
        renderGroupDevices(state.sel); renderPreview(state.sel);
      } else if(apCtx?.target==='subgroup'){
        const node = state.editingCtx?.node; if(!node) { dlg('#dlgAlarmPicker','close'); return; }
        if(chosenAlarms.length){ chosenAlarms.forEach(el=>{ const name=el.dataset.name||el.querySelector('strong').textContent; const bucket = state.agg.byName.get(name)||[]; bucket.forEach(rec=>{ if(!node.devices) node.devices=[]; node.devices.push({address:rec.path, alarmName:name}); }); }); }
        else if(selDevs.length){ selDevs.forEach(el=>{ const path=el.textContent.replace(/\s*fav\s*$/,''); if(!node.devices) node.devices=[]; node.devices.push({address:path}); }); }
        renderSgDevs();
      }
      dlg('#dlgAlarmPicker','close');
    });

    function addCtHeader(h, src){ state.ctHeaders.push({ h, src }); }
    function renderCtHeaders(){ const tbody=$('#ctHeaderTable tbody'); tbody.innerHTML=''; state.ctHeaders.forEach((item,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(item.h)}</td><td class='muted small'>${escapeHtml(item.src||'')}</td><td><span class='link' data-del='${idx}'>Remove</span></td>`; tbody.appendChild(tr); }); tbody.onclick=(e)=>{ if(e.target.matches('[data-del]')){ const i=+e.target.getAttribute('data-del'); state.ctHeaders.splice(i,1); renderCtHeaders(); } } }

    // Duplicate dialog
    bind('#btnDuplicate','click',()=>{ if(!state.sel) return toast('Select a favourite first'); $('#dupBaseName').value = state.sel.name + ' %d'; $('#dupCount').value = 3; $('#dupStructureOnly').checked = false; dlg('#dlgDuplicate','open'); });
    bind('#dupCancel','click',()=> dlg('#dlgDuplicate','close'));
    bind('#dupOk','click',()=>{ if(!state.sel) return; const base=$('#dupBaseName').value.trim(); let count=parseInt($('#dupCount').value||'1',10); count = Math.max(1, Math.min(999, count)); const structureOnly=$('#dupStructureOnly').checked; if(!/%d|%x/i.test(base)) return toast('Base name must include %d or %x');
      const created=[]; for(let i=1;i<=count;i++){
        const paddedBase = base.replace(/%0?(\d*)d/gi, (m,p)=> (p? `%0${p}d`:"%d"));
        const nameDec = paddedBase.replace(/%0?(\d*)d/gi, (m,p)=> String(i).padStart(p?parseInt(p,10):0,'0'));
        const nameHex = nameDec.replace(/%x/gi, i.toString(16).toUpperCase());
        const name=nameHex;
        if(state.groups.find(g=>g.name===name)) continue;
        const src=state.sel; const dup=JSON.parse(JSON.stringify(src)); dup.id=uid(); dup.name=name; if(structureOnly){ dup.devices=[]; (function clearDevs(sgs){ (sgs||[]).forEach(s=>{ s.devices=[]; clearDevs(s.subGroups); }); })(dup.subGroups);} state.groups.push(dup); created.push(dup.id);
      }
      state.lastAction={type:'duplicate',ids:created}; renderGroups(); dlg('#dlgDuplicate','close'); });

    // Create Template (moved into Template Browser)
    bind('#tbCreateTemplate','click',()=>{ $('#ctName').value=''; state.ctHeaders=[]; renderCtHeaders(); if(!state.connected){ openConnectDialog(); } dlg('#dlgCreateTemplate','open'); });
    bind('#ctCancel','click',()=> dlg('#dlgCreateTemplate','close'));
    bind('#ctAddManual','click',()=>{ const h=($('#ctManualHeader').value||'').trim(); if(!h) return; addCtHeader(h,'manual'); $('#ctManualHeader').value=''; renderCtHeaders(); });
    bind('#ctPick','click',()=>{ if(!state.connected){ openConnectDialog(); return; } apCtx={ target:'template' }; openAlarmPicker(); });
    bind('#ctOk','click',()=>{ const name=$('#ctName').value.trim()||''; const headers=state.ctHeaders.map(x=>x.h).filter(Boolean); if(!name) return toast('Template name required'); if(headers.length===0) return toast('Add at least one header'); const idx=state.templates.findIndex(t=>t.name===name); const tpl={ name, headers, _userCreated:true }; if(idx>=0){ // preserve any existing metadata but mark as user-created
      const existing = state.templates[idx]||{}; tpl._userCreated = existing._userCreated || true; state.templates[idx]=tpl;
    } else state.templates.push(tpl); dlg('#dlgCreateTemplate','close'); toast('Template saved locally'); try{ refreshTemplateBrowserView(); }catch(e){} });

    // Template Picker
    bind('#sgPickTemplate','click',()=>{ state._tplPickTarget='subgroup'; openPickTemplateDialog(); });
    bind('#grpPickTemplate','click',()=>{ state._tplPickTarget='group'; openPickTemplateDialog(); });
    bind('#tplPickCancel','click',()=> dlg('#dlgPickTemplate','close'));
    bind('#tplPickSearch','input',()=> renderPickTemplateList());
    bind('#tplPickOpenBrowser','click',()=>{ state._returnToPicker = true; dlg('#dlgPickTemplate','close'); dlg('#dlgTemplateBrowser','open'); refreshTemplateBrowserView(); });
    bind('#tplPickChoose','click',()=>{ const sel=$('#tplPickList .itm.sel'); if(!sel) return toast('Select a template'); const name=sel.dataset.name; if(state._tplPickTarget==='group'){ $('#grpTemplate').value=name; } else { $('#sgTemplate').value=name; } state._tplPickTarget=null; dlg('#dlgPickTemplate','close'); });
    function openPickTemplateDialog(){ const hasProject = state.projectTemplates.length>0; $('#tplIncludeProject').checked=hasProject; $('#tplIncludeProject').disabled=!hasProject; $('#tplIncludeLocal').checked=true; renderPickTemplateList(); dlg('#dlgPickTemplate','open'); }
    function openPickTemplateDialog(){ const hasProject = state.projectTemplates.length>0; $('#tplIncludeProject').checked=hasProject; $('#tplIncludeProject').disabled=!hasProject; $('#tplIncludeLocal').checked=true; renderPickTemplateList(); // show preview for current selection if present
      const cur = ($('#sgTemplate').value||'').trim(); if(cur) renderPickTemplatePreview(cur); dlg('#dlgPickTemplate','open'); }

    function getTemplateByName(name){ if(!name) return null; const n = String(name); const p = state.projectTemplates.find(t=>t.name===n); if(p) return { name:p.name, headers:p.headers||[], src:'Remote' }; const l = state.templates.find(t=>t.name===n); if(l) return { name:l.name, headers:l.headers||[], src:'Local' }; return null; }

    function renderPickTemplatePreview(name){ const view=$('#tplPickView'); if(!view) return; const tpl = getTemplateByName(name); if(!tpl){ view.innerHTML = '<div class="muted small">No template selected or headers not available.</div>'; return; } const out=[]; out.push(`<div><strong>Name:</strong> ${escapeHtml(tpl.name)}</div>`); out.push(`<div class='muted small'>Source: ${escapeHtml(tpl.src||'')}</div>`); out.push('<div style="margin-top:8px"><strong>Headers:</strong></div>'); if(Array.isArray(tpl.headers) && tpl.headers.length){ out.push('<ul>'); out.push(tpl.headers.map(h=>`<li>${escapeHtml(h)}</li>`).join('')); out.push('</ul>'); } else { out.push('<div class="muted small">(no headers)</div>'); } view.innerHTML = out.join(''); }

    function renderPickTemplateList(){ const box=$('#tplPickList'); box.innerHTML=''; const q=($('#tplPickSearch').value||'').toLowerCase(); const rows=[]; if($('#tplIncludeProject').checked) state.projectTemplates.forEach(t=> rows.push({name:t.name, src:'Remote'})); if($('#tplIncludeLocal').checked) state.templates.forEach(t=> rows.push({name:t.name, src:'Local'})); const seen=new Set(); rows.filter(r=> !q || r.name.toLowerCase().includes(q)).sort((a,b)=> a.name.localeCompare(b.name)||a.src.localeCompare(b.src)).forEach(r=>{ const key=r.name+'|'+r.src; if(seen.has(key)) return; seen.add(key); const div=document.createElement('div'); div.className='itm'; div.innerHTML=`<span>${escapeHtml(r.name)}</span> <span class='muted small'>${r.src}</span>`; div.dataset.name=r.name; div.onclick=()=>{ box.querySelectorAll('.itm').forEach(n=> n.classList.remove('sel')); div.classList.add('sel'); // update preview when selection changes
        renderPickTemplatePreview(div.dataset.name);
      }; div.ondblclick=()=>{ div.classList.add('sel'); $('#tplPickChoose').click(); }; box.appendChild(div); });
      // if current sgTemplate is visible in list, select it and show preview
      const cur = ($('#sgTemplate').value||'').trim(); if(cur){ const match = Array.from(box.querySelectorAll('.itm')).find(n=> n.dataset.name===cur); if(match){ match.classList.add('sel'); renderPickTemplatePreview(cur); } }
    }

    // Template Browser (HTTP bridge + Local)
    bind('#btnTemplateBrowser','click',()=>{ const ip=($('#cfgIp').value||'').trim()||'127.0.0.1'; const base=`http://${ip}:8080`; state.tplApi.base = state.tplApi.base || base; $('#tbUser').value = state.tplApi.user || ''; $('#tbPass').value = state.tplApi.pass || ''; renderRepoList([]); renderTplList([]); $('#tbView').textContent='No template selected.'; dlg('#dlgTemplateBrowser','open'); refreshTemplateBrowserView(); });
    bind('#tbClose','click',()=>{ dlg('#dlgTemplateBrowser','close'); if(state._returnToPicker){ state._returnToPicker=false; // reopen pick dialog and refresh its view
      try{ renderPickTemplateList(); }catch(e){} dlg('#dlgPickTemplate','open'); } });
    bind('#tbLoadRepos','click', async()=>{ await loadReposAndTemplates(); });
    bind('#tbIncludeRemote','change', refreshTemplateBrowserView);
    bind('#tbIncludeLocal','change', refreshTemplateBrowserView);

    async function loadReposAndTemplates(){ const base = state.tplApi.base || (`http://${($('#cfgIp').value||'').trim()||'127.0.0.1'}:8080`); state.tplApi.base = base; state.tplApi.user=$('#tbUser').value.trim(); state.tplApi.pass=$('#tbPass').value; 
      try{ const res = await fetch(base+'/repos', { headers: buildHeaders() }); if(!res.ok) throw new Error('HTTP '+res.status); const repos = await res.json(); renderRepoList(repos); if(Array.isArray(repos) && repos.length){ const first=repos[0]; await loadTemplatesForRepo(first.name, first.branch||'main'); }
      }catch(e){ toast('Load repos failed: '+e.message+'\nHTTP bridge must be reachable (not SSH).'); renderRepoList([]); }
      refreshTemplateBrowserView();
    }
    function buildHeaders(){ const h={'Accept':'application/json'}; const u=state.tplApi.user, p=state.tplApi.pass; if(u||p){ const b64 = btoa(`${u}:${p}`); h['Authorization'] = 'Basic '+b64; } return h; }
    function renderRepoList(repos){ const box=$('#tbRepoList'); box.innerHTML=''; (repos||[]).forEach(r=>{ const div=document.createElement('div'); div.className='itm'; div.innerHTML=`<strong>${escapeHtml(r.name||'unknown')}</strong> <span class='muted small'>${escapeHtml(r.branch||'main')}</span>`; div.dataset.name=r.name; div.dataset.branch=r.branch||'main'; div.onclick=()=>{ $$('#tbRepoList .itm').forEach(n=> n.classList.remove('sel')); div.classList.add('sel'); loadTemplatesForRepo(div.dataset.name, div.dataset.branch); }; box.appendChild(div); }); }
    async function loadTemplatesForRepo(repo, branch){ if(!repo) return; const base=state.tplApi.base; try{ const url = base + `/templates?repo=${encodeURIComponent(repo)}&branch=${encodeURIComponent(branch||'main')}`; const res = await fetch(url, { headers: buildHeaders() }); if(!res.ok) throw new Error('HTTP '+res.status); const list = await res.json(); state.projectTemplates = Array.isArray(list)? list.map(t=>({ name: t.name||t.filename||'unknown.tmpl', headers: Array.isArray(t.headers)? t.headers : [] })) : []; refreshTemplateBrowserView(); }catch(e){ toast('Load templates failed: '+e.message+'\nEnsure your HTTP bridge exposes /templates.'); state.projectTemplates=[]; refreshTemplateBrowserView(); } }
    function refreshTemplateBrowserView(){ const includeRemote = $('#tbIncludeRemote').checked; const includeLocal = $('#tbIncludeLocal').checked; const list=[]; if(includeRemote) state.projectTemplates.forEach(t=> list.push({name:t.name, headers:t.headers, src:'Remote'})); if(includeLocal) state.templates.forEach(t=> list.push({name:t.name, headers:t.headers, src:'Local'})); renderTplList(list); }
    function renderTplList(list){ const box=$('#tbTplList'); box.innerHTML=''; (list||[]).forEach(t=>{ const div=document.createElement('div'); div.className='itm'; div.innerHTML=`<strong>${escapeHtml(t.name)}</strong> <span class='muted small'>${t.src||''}</span> <span class='muted small'>headers: ${(Array.isArray(t.headers)? t.headers.length:0)}</span>`; div.onclick=()=>{
        const view = [];
        view.push(`<div><strong>Name:</strong> ${escapeHtml(t.name)}</div>`);
        view.push(`<div class="muted small">Source: ${escapeHtml(t.src||'')}</div>`);
        view.push('<div style="margin-top:8px"><strong>Headers:</strong></div>');
        if(Array.isArray(t.headers) && t.headers.length){
          view.push('<ul>');
          view.push(t.headers.map(h=>`<li>${escapeHtml(h)}</li>`).join(''));
          view.push('</ul>');
        } else {
          view.push('<div class="muted small">(no headers)</div>');
        }
        $('#tbView').innerHTML = view.join('');
        $$('#tbTplList .itm').forEach(n=> n.classList.remove('sel'));
        div.classList.add('sel');
      }; box.appendChild(div); }); }

    // Create / Undo / Save / Delete
    bind('#btnCreate','click',()=> { const name=prompt('Favourite name'); if(!name) return; if(state.groups.find(g=>g.name===name)) return toast('Name must be unique'); const g=newGroup(name); state.groups.push(g); state.lastAction={type:'create',id:g.id}; renderGroups(); state.sel=g; openEditor(g); });
    bind('#btnUndo','click',()=>{ const a=state.lastAction; if(!a) return; if(a.type==='create') state.groups = state.groups.filter(g=>g.id!==a.id); if(a.type==='duplicate') state.groups = state.groups.filter(g=>!a.ids.includes(g.id)); state.lastAction=null; state.sel=null; renderGroups(); $('#editor').style.display='none'; $('#editorEmpty').style.display=''; });
    bind('#btnDeleteGroup','click',()=>{ if(!state.sel) return; if(!confirm('Delete favourite '+state.sel.name+'?')) return; state.groups = state.groups.filter(g=>g!==state.sel); state.sel=null; renderGroups(); $('#editor').style.display='none'; $('#editorEmpty').style.display=''; });
    bind('#btnSaveGroup','click',()=>{
      if(!state.sel) return;
      state.sel.name=$('#groupName').value.trim();
      state.sel.inError=Number($('#inErrorState').value||50);
      state.sel.errorPositions=Number($('#errorPositions').value||2);
      state.sel.sorts={ p:$('#primarySort').value, s:$('#secondarySort').value, t:$('#tertiarySort').value };
      // persist global/local selection and local settings when applicable
      const useGlobal = $('#modeGlobal').checked;
      state.sel.useGlobalSettings = useGlobal;
      if(!useGlobal){
        state.sel.localSettings = {
          orientation: $('#lvOrientation').value,
          cellSpacing: Number($('#lvCellSpacing').value||0),
          latching: !!$('#lvLatching').checked,
          itemSize: Number($('#lvItemSize').value||0),
          showAddr: !!$('#lvShowAddr').checked,
          showPrio: !!$('#lvShowPrio').checked,
          showTs: !!$('#lvShowTs').checked
        };
      }
      // persist group-level template
      state.sel.template = ($('#grpTemplate').value||'').trim();
      renderGroups($('#searchGroups').value);
      openEditor(state.sel);
    });
    bind('#groupName','input',()=>{ if(!state.sel) return; $('#groupIdentifier').textContent='EM::'+$('#groupName').value.trim(); });
    bind('#searchGroups','input',(e)=> renderGroups(e.target.value));

    // Toggle Global/Local settings and enable/disable local controls
    bind('#modeGlobal','change', ()=>{ if(!state.sel) return; state.sel.useGlobalSettings = true; setLocalControlsEnabled(false); $('#modeTip').textContent='(Global is default)'; });
    bind('#modeLocal','change', ()=>{ if(!state.sel) return; state.sel.useGlobalSettings = false; setLocalControlsEnabled(true); $('#modeTip').textContent='(Local overrides Global)'; });

    function newGroup(name){ return { id:uid(), name, inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, devices:[], subGroups:[], useGlobalSettings:true, localSettings:{ orientation:'Vertical', cellSpacing:8, latching:true, itemSize:320, showAddr:true, showPrio:true, showTs:true } }; }

    // Init + sample
    renderGroups();
    bind('#btnLoadSample','click',()=>{
      state.groups=[
        { id:uid(), name:'Channel 1', devices:[{address:'F110:01:02', alarmName:null},{address:'Favourites/Playout Channels/Channel 1', alarmName:'NAME'}], inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, useGlobalSettings:true, localSettings:{orientation:'Vertical',cellSpacing:8,latching:true,itemSize:320,showAddr:true,showPrio:true,showTs:true}, subGroups:[ { name:'Playout Servers', template:'example.tmpl', devices:[{address:'F110:01:09', alarmName:'HEALTH'}], subGroups:[{ name:'DB', template:'', devices:[], subGroups:[], __path:['Playout Servers','DB'] }] } ]},
        { id:uid(), name:'Channel 2', devices:[{address:'System/Exception Monitoring/Channel 2', alarmName:'STATE'}], inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, useGlobalSettings:true, localSettings:{orientation:'Vertical',cellSpacing:8,latching:true,itemSize:320,showAddr:true,showPrio:true,showTs:true}, subGroups:[ ]},
        { id:uid(), name:'Channel 3', devices:[{address:'F110:01:06', alarmName:null},{address:'System/Exception Monitoring/Channel 1', alarmName:'MSG'}], inError:50, errorPositions:2, sorts:{p:'Priority',s:'State',t:'Date (Newest First)'}, useGlobalSettings:true, localSettings:{orientation:'Vertical',cellSpacing:8,latching:true,itemSize:320,showAddr:true,showPrio:true,showTs:true}, subGroups:[ ]}
      ];
      state.sel=state.groups[0]; renderGroups(); openEditor(state.sel);
    });

    // Generate Bundle (local, no push)
    bind('#btnGenerate','click',()=>{
      const bundle = {
        version: '11.1.0',
        createdAt: new Date().toISOString(),
        serverIp: ($('#cfgIp').value||'').trim(),
        projectVars: state.projectVars,
        master: state.master,
        favourites: state.groups,
        templates: { local: state.templates, project: state.projectTemplates.map(t=>({ name:t.name, headers:t.headers })) }
      };
      // download full bundle
      download('PenaltyBoxBundle.json', JSON.stringify(bundle, null, 2));

      // produce a favourites-only config that conforms to the favourites schema
      function deviceToNetworkItem(d){ const addr = String(d.address||''); const alarm = d.alarmName==null? null : String(d.alarmName); const name = alarm || (addr.split('/').pop()||addr); const obj = { item_type:'network_item', name: String(name||''), address: addr }; if(alarm) obj.header = alarm; return obj; }
      function subGroupToFolder(sg){ const children = [];
        (sg.subGroups||[]).forEach(ch=> children.push(subGroupToFolder(ch)));
        (sg.devices||[]).forEach(dev=> children.push(deviceToNetworkItem(dev)));
        const folder = { item_type:'favourites_folder', name: String(sg.name||'') };
        if(sg.template) folder.template = sg.template;
        if(children.length) folder.children = children;
        return folder;
      }
      function groupToFolder(g){ const children = [];
        (g.subGroups||[]).forEach(sg=> children.push(subGroupToFolder(sg)));
        (g.devices||[]).forEach(dev=> children.push(deviceToNetworkItem(dev)));
        const folder = { item_type:'favourites_folder', name: String(g.name||'') };
        if(children.length) folder.children = children;
        return folder;
      }

      const favouritesConfig = {
        version: '11.1.0',
        createdAt: new Date().toISOString(),
        serverIp: ($('#cfgIp').value||'').trim(),
        folders: (state.groups||[]).map(groupToFolder)
      };

      download('penaltyBoxFavourites.json', JSON.stringify(favouritesConfig, null, 2));
      // also generate .tmpl files for each known template (local + project)
      try{
        const makeContent = (tpl)=>{
          // produce only the headers (one per line) — no comment metadata
          if(Array.isArray(tpl.headers) && tpl.headers.length){
            return tpl.headers.map(h=> String(h)).join('\n');
          }
          return '';
        };
        // only export templates that are actually referenced by the favourites
        const referenced = new Set();
        (state.groups||[]).forEach(g=>{
          const walk = (sg)=>{
            if(sg && sg.template) referenced.add(String(sg.template));
            (sg.subGroups||[]).forEach(ch=> walk(ch));
          };
          (g.subGroups||[]).forEach(sg=> walk(sg));
        });
        // local templates: export if referenced OR explicitly created by the user
        (state.templates||[]).forEach(t=>{
          const nm = String(t.name||''); if(!nm) return;
          if(!referenced.has(nm) && !t._userCreated) return;
          const fname = nm || 'template.tmpl'; download(fname, makeContent(t));
        });
        // project/remote templates (we only have name+headers)
        (state.projectTemplates||[]).forEach(t=>{
          if(!referenced.has(String(t.name))) return; const fname = (t.name||'project-template.tmpl'); download(fname, makeContent(t));
        });
      }catch(e){ console.error('Template export failed', e); }
      toast('Bundle, favourites config and template files generated locally – no push performed');
    });
  });
</script>
</body>
</html>
